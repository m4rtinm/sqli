<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Blockly + generador Python (CDN unpkg) -->
  <script src="https://unpkg.com/blockly@10.3.1/blockly.min.js"></script>
  <script src="https://unpkg.com/blockly@10.3.1/python.min.js"></script>
  
  <!-- Tema Scratch (con pines tipo Lego) -->
  <script src="https://unpkg.com/blockly@10.3.1/themes/scratch.min.js"></script>
  
  <!-- PrismJS para resaltado Python -->
  <link rel="stylesheet" href="https://unpkg.com/prismjs/themes/prism-tomorrow.min.css" />
  <script src="https://unpkg.com/prismjs/components/prism-core.min.js"></script>
  <script src="https://unpkg.com/prismjs/components/prism-python.min.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sandbox de Desarrollo Seguro con Python (WASM) - Scratch Blocks</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet" />
  <style>
/* â€”â€”â€” COLORES â€”â€”â€” */
.block-vulnerable { background:#d32f2f; border-left:6px solid #b71c1c; }
.block-secure     { background:#43a047; border-left:6px solid #1b5e20; }
.block-neutral    { background:#546e7a; border-left:6px solid #37474f; }

    body {font-family:'Inter',sans-serif;}
    .font-fira{font-family:'Fira Code',monospace;}
    .code-editor{background:#282c34;color:#abb2bf;border:none;outline:none;resize:none;}
    .line-numbers{color:#636d83;padding-right:1rem;text-align:right;user-select:none;}
    .disabled-overlay{position:absolute;inset:0;background:rgba(0,0,0,.7);z-index:10;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.2rem;border-radius:.75rem;text-align:center;}
    .tab-button.active{border-color:#2563eb;background:#2563eb;color:#fff;}
    
    /* Blockly workspace styling */
    #blocklyDiv {
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    /* Run button styling */
    .run-button {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 1000;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .run-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
    }
    
    .run-button:disabled {
      background: #6b7280;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* Elementos que solo aparecen en modo bloques */
    .blocks-only {
      display: none;
    }
    
    .code-mode-active .blocks-only {
      display: block;
    }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">
<div class="container mx-auto p-4 md:p-8">
<header class="text-center mb-8">
  <h1 class="text-4xl font-bold text-green-600 dark:text-green-400">Sandbox de Desarrollo Seguro</h1>
  <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Programa con <span class="font-bold">bloques Scratch</span> y genera <span class="font-bold">Python real</span> en tu navegador.</p>
</header>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PANEL IZQUIERDO - BLOCKLY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-xl shadow-2xl p-6 relative">
  <div id="loading-overlay" class="disabled-overlay">
    <div class="flex flex-col items-center gap-3">
      <div class="w-8 h-8 border-4 border-dashed rounded-full animate-spin border-blue-400"></div>
      <p>Inicializando Python en el navegador...</p>
      <p class="text-sm">(Esto puede tardar unos segundos)</p>
    </div>
  </div>

  <h2 class="text-2xl font-bold mb-2">âœï¸ Editor de CÃ³digo Python</h2>
  <p class="text-gray-600 dark:text-gray-400 mb-4">Escribe tu funciÃ³n de login segura directamente en Python.</p>

  <!-- Tabs -->
  <div class="mb-4 border-b border-gray-200 dark:border-gray-700">
    <nav class="flex -mb-px" aria-label="Tabs">
      <button onclick="changeMode('code')"   id="tab-code"   class="tab-button active w-1/2 py-3 px-1 text-center border-b-2 font-medium text-sm">âœï¸ CÃ³digo</button>
      <button onclick="changeMode('blocks')" id="tab-blocks" class="tab-button      w-1/2 py-3 px-1 text-center border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700">ğŸ§© Bloques</button>
    </nav>
  </div>

  <!-- MODO CÃ“DIGO -->
  <div id="code-mode">
    <div class="bg-gray-800 rounded-lg p-4 font-fira text-sm flex">
      <div id="line-numbers" class="line-numbers"></div>
      <textarea id="code-editor" class="code-editor w-full h-96 font-fira text-sm" spellcheck="false" placeholder="Escribe tu cÃ³digo Python aquÃ­..."></textarea>
    </div>
    <p class="text-sm text-gray-500 mt-2">ğŸ’¡ Tip: Escribe tu funciÃ³n de login aquÃ­. El cÃ³digo se analizarÃ¡ automÃ¡ticamente para detectar vulnerabilidades.</p>
  </div>

  <!-- BLOCKLY WORKSPACE -->
  <div id="blocks-mode" class="hidden">
    <!-- Advertencia para vista de bloques -->
    <div class="bg-yellow-100 dark:bg-yellow-900/30 border border-yellow-400 dark:border-yellow-600 rounded-lg p-3 mb-4">
      <div class="flex items-center gap-2">
        <span class="text-yellow-600 dark:text-yellow-400">âš ï¸</span>
        <p class="text-yellow-800 dark:text-yellow-200 font-medium text-sm">Vista en desarrollo</p>
      </div>
      <p class="text-yellow-700 dark:text-yellow-300 text-xs mt-1">
        La funcionalidad de bloques estÃ¡ en fase experimental y puede presentar problemas. 
        Para mejor experiencia, utiliza la vista de cÃ³digo.
      </p>
    </div>
    
    <div id="blocklyDiv" style="height: 400px; width: 100%; position: relative;"></div>
  </div>
</div>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PANEL DERECHO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="bg-gray-900 rounded-xl shadow-2xl p-6 sticky top-8 h-max">
  <h2 class="text-2xl font-bold text-gray-200 mb-4">ğŸ”¬ GuÃ­a y VerificaciÃ³n</h2>

  <h3 class="font-semibold text-gray-300 mb-2">Checklist</h3>
  <ul class="space-y-2 text-sm">
    <li id="step-1" class="flex items-center gap-2 text-gray-400"><span class="indicator">âšª</span> Usar <code>?</code> en la query.</li>
    <li id="step-2" class="flex items-center gap-2 text-gray-400"><span class="indicator">âšª</span> Ejecutar pasando tupla de datos.</li>
    <li id="step-3" class="flex items-center gap-2 text-gray-400 blocks-only"><span class="indicator">âšª</span> Conectar bloques correctamente.</li>
  </ul>

  <div id="scan-status" class="p-4 rounded-lg mb-4"></div>

  <!-- CÃ³digo Generado - Solo en modo bloques -->
  <div id="generated-code-section" class="blocks-only">
    <h3 class="font-semibold text-gray-300 mb-2">ğŸ“ CÃ³digo Generado</h3>
    <div class="bg-black/50 rounded-lg p-4 mb-4">
      <pre id="generated-code" class="text-green-400 font-mono text-xs overflow-x-auto">// Arrastra bloques para generar cÃ³digo...</pre>
    </div>
  </div>

  <!-- Banco de Pruebas -->
  <h3 class="font-semibold text-gray-300 mb-2">ğŸ§ª Banco de Pruebas</h3>
  <p class="text-sm text-gray-400 mb-2">Payload de ataque:</p>
  <div class="bg-black/50 rounded-lg p-4">
    <div class="flex gap-2">
      <input id="test-input" value="' OR '1'='1' --" class="font-fira text-sm w-full bg-gray-700 text-gray-200 rounded-md p-2" />
      <button id="test-button" onclick="runTest()" class="bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700" disabled>Probar</button>
    </div>
    <div id="test-result" class="mt-3 text-sm min-h-[40px]"></div>
  </div>

  <!-- Controles -->
  <div class="mt-4 space-y-2">
    <!-- Botones removidos para simplificar la interfaz -->
  </div>
</div>
</div>
</div>

<!-- Toolbox XML (bloques expandidos por defecto) -->
<xml id="toolbox" style="display:none">
  <category name="ğŸš¨ CÃ³digo Vulnerable" colour="#d32f2f" expanded="true">
    <block type="function_def">
      <statement name="DO">
        <block type="vulnerable_query">
          <next>
            <block type="vulnerable_exec">
              <next>
                <block type="fetch_result">
                  <next>
                    <block type="return_result"></block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
      </statement>
    </block>
    <block type="vulnerable_query"></block>
    <block type="vulnerable_exec"></block>
  </category>
  <category name="âœ… Soluciones Seguras" colour="#43a047" expanded="true">
    <block type="function_def">
      <statement name="DO">
        <block type="secure_query">
          <next>
            <block type="secure_exec">
              <next>
                <block type="fetch_result">
                  <next>
                    <block type="return_result"></block>
                  </next>
                </block>
              </next>
            </block>
          </next>
        </block>
      </statement>
    </block>
    <block type="secure_query"></block>
    <block type="secure_exec"></block>
    <block type="fetch_result"></block>
    <block type="return_result"></block>
  </category>
  <sep />
  <category name="ğŸ Python BÃ¡sico" colour="#4b7bec" expanded="false">
    <block type="text_print">
      <value name="TEXT">
        <shadow type="text">
          <field name="TEXT">Hello World!</field>
        </shadow>
      </value>
    </block>
    <block type="controls_if"></block>
    <block type="controls_repeat_ext">
      <value name="TIMES">
        <shadow type="math_number">
          <field name="NUM">10</field>
        </shadow>
      </value>
    </block>
    <block type="variables_get">
      <field name="VAR">item</field>
    </block>
  </category>
</xml>

<!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ JS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
const el = id => document.getElementById(id);
const elements = {
  codeEditor: el('code-editor'), lineNumbers: el('line-numbers'),
  statusBox: el('scan-status'), testInput: el('test-input'),
  testResult: el('test-result'), loading: el('loading-overlay'),
  testBtn: el('test-button'), blocksMode: el('blocks-mode'),
  codeMode: el('code-mode'), tabBlocks: el('tab-blocks'),
  tabCode: el('tab-code'), step1: el('step-1'), 
  step2: el('step-2'), step3: el('step-3'),
  generatedCode: el('generated-code')
};

let pyodide, currentMode = 'code', workspace;

// CÃ³digo vulnerable por defecto
const DEFAULT_VULNERABLE_CODE = `def login(db_cursor, username, password):
    query = f"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'"
    db_cursor.execute(query)
    user = db_cursor.fetchone()
    return user`;

let isUpdatingFromCode = false;
let isUpdatingFromBlocks = false;

// Utility function to prevent infinite sync loops
function withSyncFlag(flagName, fn){
  if (window[flagName]) return;
  window[flagName] = true;
  try { fn(); } finally { window[flagName] = false; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ§© DEFINICIÃ“N DE BLOQUES Y GENERADORES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function defineCustomBlocks() {
  console.log('Definiendo bloques personalizados...');
  
  // Definir bloques personalizados con JSON
  Blockly.defineBlocksWithJsonArray([
    {
      "type": "function_def",
      "message0": "def login(db_cursor, username, password):",
      "message1": "%1",
      "args1": [{"type": "input_statement", "name": "DO"}],
      "colour": 120,
      "tooltip": "Define la funciÃ³n de login"
    },
    {
      "type": "vulnerable_query",
      "message0": "query = f\"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'\"",
      "previousStatement": null,
      "nextStatement": null,
      "colour": 0,
      "tooltip": "Query vulnerable con concatenaciÃ³n de strings"
    },
    {
      "type": "vulnerable_exec",
      "message0": "db_cursor.execute(query)",
      "previousStatement": null,
      "nextStatement": null,
      "colour": 0,
      "tooltip": "Ejecuta query sin parÃ¡metros (vulnerable)"
    },
    {
      "type": "secure_query",
      "message0": "query = \"SELECT * FROM users WHERE username = ? AND password = ?\"",
      "previousStatement": null,
      "nextStatement": null,
      "colour": 120,
      "tooltip": "Query segura con placeholders"
    },
    {
      "type": "secure_exec",
      "message0": "db_cursor.execute(query, (username, password))",
      "previousStatement": null,
      "nextStatement": null,
      "colour": 120,
      "tooltip": "Ejecuta query con parÃ¡metros (seguro)"
    },
    {
      "type": "fetch_result",
      "message0": "user = db_cursor.fetchone()",
      "previousStatement": null,
      "nextStatement": null,
      "colour": 230,
      "tooltip": "Obtiene el resultado de la consulta"
    },
    {
      "type": "return_result",
      "message0": "return user",
      "previousStatement": null,
      "colour": 230,
      "tooltip": "Retorna el resultado"
    }
  ]);

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ GENERADORES DE CÃ“DIGO PYTHON
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  Blockly.Python['function_def'] = function(block) {
    const branch = Blockly.Python.statementToCode(block, 'DO');
    return 'def login(db_cursor, username, password):\n' + branch;
  };

  Blockly.Python['vulnerable_query'] = function(block) {
    return '    query = f"SELECT * FROM users WHERE username = \'{username}\' AND password = \'{password}\'"\n';
  };

  Blockly.Python['vulnerable_exec'] = function(block) {
    return '    db_cursor.execute(query)\n';
  };

  Blockly.Python['secure_query'] = function(block) {
    return '    query = "SELECT * FROM users WHERE username = ? AND password = ?"\n';
  };

  Blockly.Python['secure_exec'] = function(block) {
    return '    db_cursor.execute(query, (username, password))\n';
  };

  Blockly.Python['fetch_result'] = function(block) {
    return '    user = db_cursor.fetchone()\n';
  };

  Blockly.Python['return_result'] = function(block) {
    return '    return user\n';
  };

  console.log('Bloques definidos correctamente');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸš€ INICIALIZACIÃ“N
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

async function init() {
  try {
    console.log('Iniciando carga...');
    
    // Verificar Blockly
    if (typeof Blockly === 'undefined') {
      throw new Error('Blockly no estÃ¡ disponible');
    }
    console.log('Blockly disponible');

    // Inicializar el generador Python si no estÃ¡ disponible
    if (typeof Blockly.Python === 'undefined') {
      console.log('Inicializando generador Python...');
      // Crear el generador Python manualmente
      Blockly.Python = new Blockly.Generator('Python');
      Blockly.Python.ORDER_ATOMIC = 0;
      Blockly.Python.ORDER_NEW = 1;
      Blockly.Python.ORDER_MEMBER = 2;
      Blockly.Python.ORDER_FUNCTION_CALL = 2;
      Blockly.Python.ORDER_UNARY_SIGN = 3;
      Blockly.Python.ORDER_POWER = 4;
      Blockly.Python.ORDER_MULTIPLICATIVE = 5;
      Blockly.Python.ORDER_ADDITIVE = 6;
      Blockly.Python.ORDER_BITWISE_SHIFT = 7;
      Blockly.Python.ORDER_BITWISE_AND = 8;
      Blockly.Python.ORDER_BITWISE_XOR = 9;
      Blockly.Python.ORDER_BITWISE_OR = 10;
      Blockly.Python.ORDER_RELATIONAL = 11;
      Blockly.Python.ORDER_LOGICAL_NOT = 12;
      Blockly.Python.ORDER_LOGICAL_AND = 13;
      Blockly.Python.ORDER_LOGICAL_OR = 14;
      Blockly.Python.ORDER_CONDITIONAL = 15;
      Blockly.Python.ORDER_LAMBDA = 16;
      Blockly.Python.ORDER_NONE = 99;
      
      // Palabras reservadas como string
      Blockly.Python.RESERVED_WORDS_ = 
        'and,as,assert,break,class,continue,def,del,elif,else,except,exec,' +
        'finally,for,from,global,if,import,in,is,lambda,not,or,pass,print,' +
        'raise,return,try,while,with,yield,' +
        'True,False,None,NotImplemented,Ellipsis,__debug__,quit,exit,' +
        'copyright,license,credits,help';
      
      Blockly.Python.init = function(workspace) {
        if (!Blockly.Python.nameDB_) {
          Blockly.Python.nameDB_ = new Blockly.Names(Blockly.Python.RESERVED_WORDS_);
        } else {
          Blockly.Python.nameDB_.reset();
        }
        Blockly.Python.nameDB_.setVariableMap(workspace.getVariableMap());
        Blockly.Python.definitions_ = Object.create(null);
      };
      
      Blockly.Python.finish = function(code) {
        const definitions = Blockly.Python.definitions_;
        Blockly.Python.definitions_ = Object.create(null);
        Blockly.Python.nameDB_.reset();
        return code;
      };
    }
    console.log('Blockly.Python disponible');

    // Definir bloques personalizados
    defineCustomBlocks();

    // Inicializar Blockly workspace
    initBlockly();
    console.log('Workspace inicializado');

    // Inicializar Pyodide en paralelo
    console.log('Cargando Pyodide...');
    pyodide = await loadPyodide(); 
    await pyodide.loadPackage('sqlite3');
    console.log('Pyodide cargado');

    // DB en memoria
    pyodide.runPython(`
import sqlite3, textwrap, sys
db_connection = sqlite3.connect(":memory:")
db_cursor = db_connection.cursor()
db_cursor.execute("CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, password TEXT);")
db_cursor.executemany("INSERT INTO users VALUES (?, ?, ?);", [(1,'admin','pass123'),(2,'juan','qwerty')])
db_connection.commit()
`);
    console.log('Base de datos inicializada');

    // Habilitar controles
    elements.testBtn.disabled = false;

    elements.loading.style.display = 'none';
    analyzeSolution();
    
    console.log('InicializaciÃ³n completada');
    
  } catch (e) {
    console.error('Error en inicializaciÃ³n:', e);
    elements.loading.innerHTML = `<p>Error al cargar: ${e.message}</p>`;
  }
}

function initBlockly() {
  console.log('Inicializando workspace de Blockly...');
  
  // Crear el workspace
  workspace = Blockly.inject('blocklyDiv', {
    toolbox: document.getElementById('toolbox'),
    scrollbars: true,
    trashcan: true,
    zoom: {
      controls: true,
      wheel: true,
      startScale: 1,
      maxScale: 3,
      minScale: 0.3
    },
    move: {
      scrollbars: true,
      drag: true,
      wheel: true
    },
    grid: {
      spacing: 20,
      length: 3,
      colour: '#ccc',
      snap: true
    }
  });

  // Inicializar el generador Python con el workspace
  if (Blockly.Python && Blockly.Python.init) {
    Blockly.Python.init(workspace);
  }

  // Cargar workspace inicial con cÃ³digo vulnerable
  const xmlText = `
<xml>
  <block type="function_def" x="20" y="20">
    <statement name="DO">
      <block type="vulnerable_query">
        <next>
          <block type="vulnerable_exec">
            <next>
              <block type="fetch_result">
                <next>
                  <block type="return_result"></block>
                </next>
              </block>
            </next>
          </block>
        </next>
      </block>
    </statement>
  </block>
</xml>`;
  
  try {
    Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xmlText), workspace);
    console.log('Workspace inicial cargado');
  } catch (error) {
    console.error('Error al cargar workspace inicial:', error);
  }

  // Event listeners para cambios en workspace
  workspace.addChangeListener(function(event) {
    if (event.type !== Blockly.Events.UI && !isUpdatingFromCode) {
      updateGeneratedCode();
      if (currentMode === 'code') {
        if (!isUpdatingFromCode) updateCodeEditor();
      }
      analyzeSolution();
    }
  });

  // Event listener para cambios en el editor de cÃ³digo
  elements.codeEditor.addEventListener('input', function() {
    if (!isUpdatingFromBlocks) {
      updateLines();
      updateGeneratedCode();
      analyzeSolution();
      
      // Solo actualizar bloques si estamos en modo bloques y hay contenido
      if (currentMode === 'blocks' && this.value.trim()) {
        // Debounce para evitar actualizaciones excesivas
        clearTimeout(this.updateTimer);
        this.updateTimer = setTimeout(updateBlocksFromCode, 400);
      }
    }
  });

  // Event listener adicional para detectar cambios cuando se cambia de pestaÃ±a
  elements.codeEditor.addEventListener('blur', function() {
    if (!isUpdatingFromBlocks && currentMode === 'blocks') {
      updateBlocksFromCode();
    }
  });

  // Inicializar con cÃ³digo por defecto
  elements.codeEditor.value = DEFAULT_VULNERABLE_CODE;
  updateLines();
  updateGeneratedCode();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ® CONTROLES Y MODOS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

window.changeMode = mode => {
  currentMode = mode;
  elements.codeMode.classList.toggle('hidden', mode !== 'code');
  elements.blocksMode.classList.toggle('hidden', mode !== 'blocks');
  elements.tabCode.classList.toggle('active', mode === 'code');
  elements.tabBlocks.classList.toggle('active', mode === 'blocks');
  
  // Controlar visibilidad de elementos especÃ­ficos de cada modo
  const rightPanel = document.querySelector('.bg-gray-900');
  if (mode === 'blocks') {
    rightPanel.classList.add('code-mode-active');
  } else {
    rightPanel.classList.remove('code-mode-active');
  }
  
  if (mode === 'blocks') {
    // Al cambiar a bloques, actualizar los bloques con el cÃ³digo del editor
    updateBlocksFromCode();
    // Asegurar que el workspace se redibuje correctamente
    setTimeout(() => {
      if (workspace) {
        workspace.resizeContents();
        workspace.render();
      }
    }, 200);
  } else if (mode === 'code') {
    // Al cambiar a cÃ³digo, actualizar el editor con el cÃ³digo actual de los bloques si es necesario
    // Solo si el editor estÃ¡ vacÃ­o o tiene el cÃ³digo por defecto
    if (!elements.codeEditor.value.trim() || elements.codeEditor.value === DEFAULT_VULNERABLE_CODE) {
      updateCodeEditor();
    }
  }
  
  // Actualizar el cÃ³digo mostrado en el panel derecho
  updateGeneratedCode();
  analyzeSolution();
};

function updateGeneratedCode() {
  const code = currentMode === 'code'
      ? elements.codeEditor.value
      : Blockly.Python.workspaceToCode(workspace) || '// VacÃ­o';
  elements.generatedCode.textContent = code;
}

function updateCodeEditor() {
  withSyncFlag('isUpdatingFromBlocks', () => {
    const code = Blockly.Python.workspaceToCode(workspace) || DEFAULT_VULNERABLE_CODE;
    elements.codeEditor.value = code;
    updateLines();
    updateGeneratedCode();
  });
}

// Nueva funciÃ³n para actualizar bloques desde cÃ³digo
function updateBlocksFromCode() {
  withSyncFlag('isUpdatingFromCode', () => {
    const code = elements.codeEditor.value.trim();
    if (!code) return;

    /* 1. Analizar â†’ lista de bloques */
    const blocks = parseCodeToBlocks(code);
    if (!blocks.length) return;

    /* 2. Cargar en workspace sin disparar eventos */
    Blockly.Events.disable();
    try {
      workspace.clear();
      loadBlocksToWorkspace(blocks);
    } finally {
      Blockly.Events.enable();
    }

    /* 3. Refrescar vistas derivadas */
    updateGeneratedCode();
  });
}

// FunciÃ³n para parsear cÃ³digo y convertir a estructura de bloques
function parseCodeToBlocks(code) {
  const lines = code.split('\n').map(line => line.trim()).filter(line => line && !line.startsWith('#'));
  const blocks = [];
  
  let inFunction = false;
  
  for (const line of lines) {
    if (line.startsWith('def login(')) {
      blocks.push({ type: 'function_def' });
      inFunction = true;
    } else if (inFunction) {
      // Detectar query vulnerable (con f-strings o concatenaciÃ³n)
      if (line.includes('f"SELECT') || line.includes("f'SELECT") || 
          line.includes(`'{username}'`) || line.includes(`'{password}'`)) {
        blocks.push({ type: 'vulnerable_query' });
      }
      // Detectar query segura (con placeholders ?)
      else if ((line.includes('"SELECT') || line.includes("'SELECT")) && 
               line.includes('?') && line.includes('username') && line.includes('password')) {
        blocks.push({ type: 'secure_query' });
      }
      // Detectar ejecuciÃ³n vulnerable (sin parÃ¡metros)
      else if (line.includes('execute(query)') && !line.includes('execute(query,')) {
        blocks.push({ type: 'vulnerable_exec' });
      }
      // Detectar ejecuciÃ³n segura (con parÃ¡metros)
      else if ((line.includes('execute(query,') || line.includes('execute(query, (')) &&
               line.includes('username') && line.includes('password')) {
        blocks.push({ type: 'secure_exec' });
      }
      // Detectar fetchone
      else if (line.includes('fetchone()')) {
        blocks.push({ type: 'fetch_result' });
      }
      // Detectar return
      else if (line.includes('return')) {
        blocks.push({ type: 'return_result' });
      }
    }
  }
  
  return blocks;
}

// FunciÃ³n para cargar bloques al workspace
function loadBlocksToWorkspace(blocks) {
  if (blocks.length === 0) return;
  
  let xmlText = '<xml>';
  
  if (blocks[0].type === 'function_def') {
    xmlText += '<block type="function_def" x="20" y="20">';
    
    if (blocks.length > 1) {
      xmlText += '<statement name="DO">';
      
      for (let i = 1; i < blocks.length; i++) {
        if (i === 1) {
          xmlText += `<block type="${blocks[i].type}">`;
        } else {
          xmlText += `<next><block type="${blocks[i].type}">`;
        }
      }
      
      // Cerrar los next blocks
      for (let i = 2; i < blocks.length; i++) {
        xmlText += '</block></next>';
      }
      if (blocks.length > 1) {
        xmlText += '</block>';
      }
      
      xmlText += '</statement>';
    }
    
    xmlText += '</block>';
  }
  
  xmlText += '</xml>';
  
  try {
    Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(xmlText), workspace);
  } catch (error) {
    console.error('Error cargando bloques:', error);
  }
}

// FunciÃ³n de fallback para generar cÃ³digo manualmente
function generateCodeManually(workspace) {
  const blocks = workspace.getAllBlocks();
  let code = '';
  
  // Buscar el bloque principal (function_def)
  const mainBlock = blocks.find(block => block.type === 'function_def');
  if (!mainBlock) {
    return '# No se encontrÃ³ bloque de funciÃ³n';
  }
  
  code += 'def login(db_cursor, username, password):\n';
  
  // Obtener bloques conectados
  let currentBlock = mainBlock.getInputTargetBlock('DO');
  while (currentBlock) {
    switch (currentBlock.type) {
      case 'vulnerable_query':
        code += '    query = f"SELECT * FROM users WHERE username = \'{username}\' AND password = \'{password}\'"\n';
        break;
      case 'secure_query':
        code += '    query = "SELECT * FROM users WHERE username = ? AND password = ?"\n';
        break;
      case 'vulnerable_exec':
        code += '    db_cursor.execute(query)\n';
        break;
      case 'secure_exec':
        code += '    db_cursor.execute(query, (username, password))\n';
        break;
      case 'fetch_result':
        code += '    user = db_cursor.fetchone()\n';
        break;
      case 'return_result':
        code += '    return user\n';
        break;
    }
    currentBlock = currentBlock.getNextBlock();
  }
  
  return code;
}

function updateLines() {
  const code = elements.codeEditor.value;
  elements.lineNumbers.innerHTML = code.split('\n').map((_, i) => i + 1).join('<br>');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ” ANÃLISIS DE SEGURIDAD
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function analyzeSolution() {
  if (!workspace) {
    return;
  }
  
  try {
    let code;
    
    // Usar el cÃ³digo del editor si estamos en modo cÃ³digo, o generar desde bloques
    if (currentMode === 'code') {
      code = elements.codeEditor.value;
    } else {
      if (Blockly.Python && typeof Blockly.Python.workspaceToCode === 'function') {
        code = Blockly.Python.workspaceToCode(workspace);
      } else {
        code = generateCodeManually(workspace);
      }
    }
    
    // Verificar patrones de seguridad
    const hasSecureQuery = code.includes('username = ?') && code.includes('password = ?');
    const hasSecureExec = code.includes('execute(query, (username, password))') || 
                         code.includes('execute(query,(username,password))');
    const hasBlocks = workspace.getAllBlocks().length > 1 || code.trim().length > 0;
    
    // Verificar vulnerabilidades
    const isVulnerable = code.includes('f"SELECT') || code.includes("f'SELECT") ||
                        code.includes(`'{username}'`) || code.includes(`'{password}'`);
    
    // Actualizar checklist
    setStep(elements.step1, hasSecureQuery);
    setStep(elements.step2, hasSecureExec);
    setStep(elements.step3, hasBlocks);
    
    // Actualizar status
    if (hasSecureQuery && hasSecureExec) {
      setStatus('âœ… Â¡CÃ“DIGO SEGURO!', 'green', 
        'Excelente, la consulta estÃ¡ parametrizada correctamente.');
    } else if (isVulnerable) {
      setStatus('ğŸš¨ Â¡VULNERABLE!', 'red', 
        'Detectada concatenaciÃ³n de strings. Usa placeholders (?) en su lugar.');
    } else {
      setStatus('ğŸ¤” En progreso', 'yellow', 
        'Construye tu funciÃ³n de login arrastrando los bloques correctos.');
    }
  } catch (error) {
    console.error('Error analizando soluciÃ³n:', error);
  }
}

function setStep(elm, ok) {
  elm.classList.toggle('text-green-400', ok);
  elm.classList.toggle('text-gray-400', !ok);
  elm.querySelector('.indicator').textContent = ok ? 'âœ…' : 'âšª';
}

function setStatus(title, color, msg) {
  elements.statusBox.className = `p-4 rounded-lg mb-4 bg-${color}-100 dark:bg-${color}-900/40`;
  elements.statusBox.innerHTML = `<h3 class="font-bold text-${color}-800 dark:text-${color}-200">${title}</h3><p class="text-sm mt-1 text-${color}-700 dark:text-${color}-300">${msg}</p>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ§ª TESTING
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

window.runTest = async () => {
  if (!pyodide) {
    elements.testResult.innerHTML = '<p class="text-red-400">Sistema no inicializado</p>';
    return;
  }
  
  try {
    const payload = elements.testInput.value;
    let userCode;
    
    // Obtener cÃ³digo segÃºn el modo actual
    if (currentMode === 'code') {
      userCode = elements.codeEditor.value;
    } else {
      if (Blockly.Python && typeof Blockly.Python.workspaceToCode === 'function') {
        userCode = Blockly.Python.workspaceToCode(workspace);
      } else {
        userCode = generateCodeManually(workspace);
      }
    }
    
    if (!userCode || userCode.trim() === '') {
      elements.testResult.innerHTML = '<p class="text-red-400">No hay cÃ³digo para probar</p>';
      return;
    }
    
    elements.testResult.innerHTML = '<p class="text-blue-400">ğŸ” Ejecutando prueba de inyecciÃ³n SQL...</p>';
    
    // Crear el cÃ³digo de prueba completo
    const testCode = `
# Preparar base de datos de prueba
import sqlite3
db_connection = sqlite3.connect(":memory:")
db_cursor = db_connection.cursor()
db_cursor.execute("CREATE TABLE users (id INTEGER PRIMARY KEY, username TEXT, password TEXT);")
db_cursor.executemany("INSERT INTO users VALUES (?, ?, ?);", [
    (1, 'admin', 'pass123'),
    (2, 'juan', 'qwerty'),
    (3, 'maria', 'secret456')
])
db_connection.commit()

# CÃ³digo del usuario
${userCode}

# Prueba con payload de inyecciÃ³n
payload = """${payload}"""
password_test = "whatever"

print("=== PRUEBA DE INYECCIÃ“N SQL ===")
print(f"Payload usado: {payload}")
print(f"Password: {password_test}")
print()

try:
    result = login(db_cursor, payload, password_test)
    
    print("=== RESPUESTA DE LA BASE DE DATOS ===")
    if result:
        print(f"Resultado devuelto: {result}")
        console.log(result);
        print(f"Tipo: {type(result)}")
        if isinstance(result, tuple) and len(result) >= 2:
            print(f"ID: {result[0]}, Username: {result[1]}, Password: {result[2] if len(result) > 2 else 'N/A'}")
        
        # Verificar todos los usuarios para detectar inyecciÃ³n masiva
        db_cursor.execute("SELECT * FROM users")
        all_users = db_cursor.fetchall();
        console.log(all_users);
        print(f"\\nTodos los usuarios en la base de datos:")
        for user in all_users:
            print(f"  - ID: {user[0]}, Username: {user[1]}, Password: {user[2]}")
        
        print("\\nğŸš¨ RESULTADO: VULNERABLE")
        print("   Â¡La inyecciÃ³n SQL funcionÃ³!")
        print("   El cÃ³digo no estÃ¡ protegido contra inyecciÃ³n SQL.")
        
        output_result = "VULNERABLE"
        output_data = {
            "result": result,
            "all_users": all_users,
            "user_found": result[1] if result and len(result) > 1 else "Desconocido"
        }
    else:
        print("Resultado: None (no se encontrÃ³ usuario)")
        print("\\nâœ… RESULTADO: PROTEGIDO")
        print("   No se encontrÃ³ usuario con el payload.")
        print("   El cÃ³digo rechazÃ³ correctamente la inyecciÃ³n SQL.")
        output_result = "PROTEGIDO"
        output_data = {"result": None};
        
except Exception as e:
    print(f"\\nâš ï¸ EXCEPCIÃ“N CAPTURADA: {str(e)}")
    print("\\nâœ… RESULTADO: ERROR CONTROLADO")
    print("   El cÃ³digo fallÃ³ de manera segura.")
    print("   Esto generalmente indica protecciÃ³n contra inyecciÃ³n SQL.")
    output_result = "ERROR_CONTROLADO"
    output_data = {"error": str(e)};

import json
json.dumps({"status": output_result, "data": output_data})
`;

    const result = await pyodide.runPythonAsync(testCode);
    
    let resultData;
    try {
      resultData = JSON.parse(result);
    } catch {
      resultData = { status: "ERROR", data: {} };
    }
    
    // Mostrar resultado visual detallado
    if (resultData.status === 'VULNERABLE') {
      const userData = resultData.data;
      elements.testResult.innerHTML = `
        <div class="bg-red-900/50 border border-red-600 rounded-lg p-3">
          <p class="text-red-400 font-bold">ğŸš¨ CÃ“DIGO VULNERABLE</p>
          <p class="text-red-300 text-xs mt-1">La inyecciÃ³n SQL fue exitosa. El payload logrÃ³ acceder a datos no autorizados.</p>
          
          <div class="mt-3 bg-black/30 rounded p-2">
            <p class="text-red-200 text-xs font-semibold">ğŸ“Š Respuesta de la base de datos:</p>
            <p class="text-red-100 text-xs mt-1">Usuario encontrado: <span class="font-mono">${userData.user_found}</span></p>
            <p class="text-red-100 text-xs">Datos completos: <span class="font-mono">${JSON.stringify(userData.result)}</span></p>
            ${userData.all_users && userData.all_users.length > 1 ? 
              `<p class="text-red-100 text-xs mt-1">âš ï¸ Se expusieron ${userData.all_users.length} usuarios total</p>` : ''}
          </div>
          
          <p class="text-red-200 text-xs mt-2"><strong>RecomendaciÃ³n:</strong> Usa consultas parametrizadas con placeholders (?)</p>
        </div>`;
    } else if (resultData.status === 'PROTEGIDO') {
      elements.testResult.innerHTML = `
        <div class="bg-green-900/50 border border-green-600 rounded-lg p-3">
          <p class="text-green-400 font-bold">âœ… CÃ“DIGO SEGURO</p>
          <p class="text-green-300 text-xs mt-1">El cÃ³digo rechazÃ³ correctamente la inyecciÃ³n SQL.</p>
          
          <div class="mt-3 bg-black/30 rounded p-2">
            <p class="text-green-200 text-xs font-semibold">ğŸ“Š Respuesta de la base de datos:</p>
            <p class="text-green-100 text-xs mt-1">Resultado: <span class="font-mono">None</span></p>
            <p class="text-green-100 text-xs">El payload fue rechazado y no se devolvieron datos.</p>
          </div>
          
          <p class="text-green-200 text-xs mt-2"><strong>Â¡Excelente!</strong> Las consultas parametrizadas funcionan correctamente.</p>
        </div>`;
    } else {
      const errorMsg = resultData.data?.error || 'Error desconocido';
      elements.testResult.innerHTML = `
        <div class="bg-yellow-900/50 border border-yellow-600 rounded-lg p-3">
          <p class="text-yellow-400 font-bold">âš ï¸ ERROR EN EJECUCIÃ“N</p>
          <p class="text-yellow-300 text-xs mt-1">El cÃ³digo fallÃ³ durante la ejecuciÃ³n, pero esto puede ser seguro.</p>
          
          <div class="mt-3 bg-black/30 rounded p-2">
            <p class="text-yellow-200 text-xs font-semibold">ğŸ“Š Error capturado:</p>
            <p class="text-yellow-100 text-xs mt-1 font-mono">${errorMsg}</p>
          </div>
          
          <p class="text-yellow-200 text-xs mt-2">Verifica que tu funciÃ³n estÃ© correctamente implementada.</p>
        </div>`;
    }
    
  } catch (error) {
    console.error('Error en prueba:', error);
    elements.testResult.innerHTML = `
      <div class="bg-red-900/50 border border-red-600 rounded-lg p-3">
        <p class="text-red-400 font-bold">âŒ ERROR EN PRUEBA</p>
        <p class="text-red-300 text-xs mt-1">${error.message}</p>
      </div>`;
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ INICIALIZACIÃ“N FINAL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// Usar window.onload en lugar de DOMContentLoaded para asegurar que todos los scripts estÃ©n cargados
window.onload = function() {
  console.log('Window loaded, iniciando aplicaciÃ³n...');
  
  // PequeÃ±o delay para asegurar que Blockly estÃ© completamente inicializado
  setTimeout(() => {
    init().catch(error => {
      console.error('Error en inicializaciÃ³n:', error);
      if (elements.loading) {
        elements.loading.innerHTML = `<p>Error: ${error.message}</p>`;
      }
    });
  }, 500);
};
</script>

<!-- Pie de pÃ¡gina -->
<footer class="text-center mt-12 py-6 border-t border-gray-200 dark:border-gray-700">
  <p class="text-gray-600 dark:text-gray-400 text-sm">
    Simulador Educativo de SQLI <br> 
    make with â¤ï¸ by <a href="https://www.linkedin.com/in/martin-munoz/" target="_blank" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200 transition-colors">Martin MuÃ±oz</a>
  </p>
</footer>

</body>
</html>