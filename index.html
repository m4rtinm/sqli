<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Hacking: Inyección SQL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-fira { font-family: 'Fira Code', monospace; }
        .sql-blue { color: #569cd6; font-weight: bold; }
        .sql-green { color: #ce9178; font-weight: 500; }
        .sql-red { 
            background-color: rgba(255, 40, 40, 0.6) !important; 
            border-radius: 6px; 
            padding: 3px 6px !important; 
            border: 2px solid #ff3333 !important;
            position: relative;
            font-weight: bold !important;
            color: #ffffff !important;
            text-shadow: 0 0 4px rgba(255, 0, 0, 0.8);
            box-shadow: 0 0 8px rgba(255, 40, 40, 0.5);
            animation: pulseRed 2s infinite;
        }
        .sql-gray { color: #6a9955; font-weight: 500; }
        @keyframes pulseRed {
            0%, 100% { 
                background-color: rgba(255, 40, 40, 0.6);
                box-shadow: 0 0 8px rgba(255, 40, 40, 0.5);
            }
            50% { 
                background-color: rgba(255, 60, 60, 0.8);
                box-shadow: 0 0 12px rgba(255, 40, 40, 0.8);
            }
        }
        .sql-red::before {
            content: "⚠️ INYECCIÓN";
            position: absolute;
            top: -22px;
            left: 0;
            font-size: 10px;
            background: #ff3333;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
            border: 1px solid #fff;
        }
        .query-structure {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border-left: 4px solid #569cd6;
        }
        .meta-query {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.1), rgba(255, 150, 150, 0.05));
            border: 1px solid rgba(255, 100, 100, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        .meta-query p {
            margin: 4px 0;
            font-size: 0.9em;
        }
        .complex-query {
            background: linear-gradient(135deg, rgba(150, 100, 255, 0.1), rgba(200, 150, 255, 0.05));
            border: 1px solid rgba(150, 100, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        .complex-query p {
            margin: 4px 0;
            font-size: 0.9em;
        }
        .analysis-responsive {
            transition: all 0.3s ease;
            resize: vertical;
        }
        .vulnerability-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .vuln-safe { background: #22c55e; color: white; }
        .vuln-warning { background: #f59e0b; color: white; }
        .vuln-danger { background: #ef4444; color: white; }
        .smooth-scroll { scroll-behavior: smooth; }
        .challenge-card.locked {
            opacity: 0.6;
            background-color: #f3f4f6;
        }
        .challenge-card.locked .challenge-content {
            filter: blur(2px);
        }
        .challenge-card.completed {
            border-left-color: #22c55e;
        }
        .toast {
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Notificación Toast -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl z-50">
        <p id="toast-message">¡Nivel desbloqueado!</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600 dark:text-blue-400">Laboratorio de Hacking: SQLi</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Completa los desafíos para convertirte en un experto en Inyección SQL.</p>
        </header>

        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-8">
            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full relative overflow-hidden" style="width: 0%; transition: width 0.5s ease-in-out;">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse"></div>
            </div>
        </div>
        <div class="text-center mb-4">
            <span id="progress-text" class="text-sm text-gray-600 dark:text-gray-400">0% completado - ¡Comienza tu aventura!</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Panel Izquierdo: Desafíos -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold">🎯 Desafíos de Inyección</h2>
                
                <!-- Desafío 1: Inyección Clásica -->
                <div id="challenge-1" class="challenge-card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Nivel 1: El Login Roto</h3>
                        <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Clásica / Booleana</span>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">La página de login de "ShopSafe" es vulnerable. Tu misión: acceder como <code class="font-fira text-sm">'admin'</code> sin saber la contraseña.</p>
                        <form id="form-1" class="space-y-4 mt-4">
                            <input type="text" id="input-1-user" placeholder="Usuario" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2" value="admin">
                            <input type="password" id="input-1-pass" placeholder="Contraseña" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py button:hover="bg-blue-700" py-2 px-4 rounded-md hover:bg-blue-700">Intentar Inyección</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(1)" class="text-sm text-blue-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-1" class="hidden mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 text-sm rounded">Intenta usar una condición que siempre sea verdadera, como <code class="font-fira">' OR '1'='1</code>, y luego comenta el resto de la consulta con <code class="font-fira">--</code>.</p>
                        <div id="result-1" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desafío 2: Ataque de UNION -->
                <div id="challenge-2" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-gray-500">
                     <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Nivel 2: El Buscador Curioso</h3>
                        <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Ataque UNION</span>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">El buscador de productos es vulnerable. Usa un ataque <code class="font-fira">UNION</code> para extraer los nombres de usuario y contraseñas de la tabla <code class="font-fira">'users'</code>.</p>
                        <form id="form-2" class="flex gap-2 mt-4">
                            <input type="text" id="input-2-search" placeholder="Buscar producto..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hover:bg-yellow-600">Buscar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(2)" class="text-sm text-yellow-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-2" class="hidden mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 text-sm rounded">La consulta original selecciona 2 columnas. Cierra la cadena con <code class="font-fira">'</code> y luego une una consulta que seleccione 2 columnas de la tabla <code class="font-fira">users</code>, como <code class="font-fira">username, password</code>.</p>
                        <div id="result-2" class="mt-4 space-y-2"></div>
                    </div>
                </div>

                <!-- Desafío 3: Inyección a Ciegas -->
                <div id="challenge-3" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-gray-500">
                     <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Nivel 3: El Cupón Paciente</h3>
                        <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">A Ciegas / Basada en Tiempo</span>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">No verás un error ni datos, pero puedes confirmar la vulnerabilidad si el servidor tarda en responder. Inyecta un comando que cause un retraso de 3 segundos.</p>
                        <form id="form-3" class="flex gap-2 mt-4">
                            <input type="text" id="input-3-coupon" placeholder="Código de cupón..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">Validar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(3)" class="text-sm text-red-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-3" class="hidden mt-2 p-2 bg-red-50 dark:bg-red-900/20 text-sm rounded">Usa un payload que ejecute una función de espera. Para esta demo, la función se llama <code class="font-fira">SLEEP(seconds)</code>. Prueba con algo como <code class="font-fira">' AND SLEEP(3)--</code>.</p>
                        <div id="result-3" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desafío 4: Inyección basada en errores -->
                <div id="challenge-4" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Nivel 4: ¡Provoca un Error!</h3>
                        <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300">Error-Based</span>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">
                            El sistema muestra mensajes de error de la base de datos. Intenta provocar un error para revelar información sensible usando una inyección en el campo de búsqueda.
                        </p>
                        <form id="form-4" class="flex gap-2 mt-4">
                            <input type="text" id="input-4-search" placeholder="Buscar producto..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700">Buscar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(4)" class="text-sm text-purple-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-4" class="hidden mt-2 p-2 bg-purple-50 dark:bg-purple-900/20 text-sm rounded">
                            Los errores de MySQL a menudo revelan información valiosa. Intenta usar <code class="font-fira">information_schema</code> con una subconsulta que fuerce un error. Las funciones como <code class="font-fira">FLOOR(RAND()*2)</code> y <code class="font-fira">COUNT(*)</code> pueden ayudar.
                        </p>
                        <div id="result-4" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desafío 5: Inyección en ORDER BY/LIMIT -->
                <div id="challenge-5" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-pink-500">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Nivel 5: Manipula el Orden</h3>
                        <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-300">ORDER BY/LIMIT</span>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">
                            El sistema permite ordenar los resultados. Intenta manipular el parámetro de orden para provocar un error o filtrar información.
                        </p>
                        <form id="form-5" class="flex gap-2 mt-4">
                            <input type="text" id="input-5-order" placeholder="Campo para ordenar (por ejemplo: name)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-md hover:bg-pink-700">Ordenar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(5)" class="text-sm text-pink-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-5" class="hidden mt-2 p-2 bg-pink-50 dark:bg-pink-900/20 text-sm rounded">
                            El campo ORDER BY normalmente acepta nombres de columnas como 'name' o 'id'. ¿Qué pasaría si intentas inyectar SQL después de un punto y coma <code class="font-fira">;</code> o usar subconsultas con <code class="font-fira">UNION SELECT</code>?
                        </p>
                        <div id="result-5" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desafío 6: Inyección en Subconsulta -->
                <div id="challenge-6" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-indigo-500">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xl font-bold">Nivel 6: Subconsulta Maliciosa</h3>
                        <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300">Subconsulta</span>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">
                            El sistema usa subconsultas para validar datos. Intenta inyectar una subconsulta para filtrar información sensible.
                        </p>
                        <form id="form-6" class="flex gap-2 mt-4">
                            <input type="text" id="input-6-check" placeholder="Introduce un valor..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Validar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(6)" class="text-sm text-indigo-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-6" class="hidden mt-2 p-2 bg-indigo-50 dark:bg-indigo-900/20 text-sm rounded">
                            Las subconsultas pueden devolver TRUE o FALSE. Si puedes hacer que una subconsulta con <code class="font-fira">SELECT COUNT(*)</code> devuelva un número mayor que 0, podrías saltarte la validación. Piensa en condiciones que siempre sean verdaderas.
                        </p>
                        <div id="result-6" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

            </div>

            <!-- Panel Derecho: Vista del Servidor -->
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 flex flex-col sticky top-8 h-max">
                <h2 class="text-2xl font-bold text-gray-200">🖥️ Vista del "Servidor"</h2>
                
                <!-- Consulta SQL en tiempo real -->
                <div class="mt-4">
                    <h3 class="font-semibold text-gray-300 mb-2">Server: SQL Query Log en tiempo real</h3>
                    <div class="bg-black rounded-lg p-4 font-fira text-sm overflow-x-auto border border-gray-700" id="query-container">
                        <pre id="sql-query-display" class="text-gray-300 m-0 whitespace-pre-wrap leading-relaxed">// Esperando una interacción...</pre>
                    </div>
                    
                    <!-- Indicador de vulnerabilidad -->
                    <div class="mt-2 flex items-center justify-between">
                        <span id="vulnerability-status" class="vulnerability-indicator vuln-safe">SEGURA</span>
                        <span id="injection-type" class="text-xs text-gray-400"></span>
                    </div>
                   <!-- Consulta desglosada en tiempo real -->
                   <div class="mt-4">
                       <h3 class="font-semibold text-gray-300 mb-2">Visor HTML</h3>
                       <div class="bg-gray-800 rounded-lg p-4 font-fira text-sm overflow-x-auto border border-gray-700" id="query-step-container">
                           <pre id="sql-query-step" class="text-gray-300 m-0 whitespace-pre-wrap leading-relaxed">// Esperando una interacción...</pre>
                       </div>
                   </div>
                </div>

                <!-- Análisis detallado -->
                <div id="analysis-box" class="mt-4">
                     <h3 class="font-semibold text-gray-300 mb-2">🔬 Análisis del Payload</h3>
                     <div id="analysis-content" class="p-3 bg-gray-800 rounded-lg text-sm text-gray-300 min-h-[80px] overflow-y-auto analysis-responsive" style="max-height: none;">
                        💡 Escribe en un campo para ver el análisis en tiempo real.
                     </div>
                </div>

                <!-- Estructura de la consulta -->
                <div id="query-breakdown" class="mt-4">
                    <h3 class="font-semibold text-gray-300 mb-2">🧩 Estructura de la Consulta</h3>
                    <div id="breakdown-content" class="p-3 bg-gray-800 rounded-lg text-sm text-gray-300 min-h-[60px]">
                        // La estructura aparecerá aquí
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- ESTADO DEL JUEGO Y CONFIGURACIÓN ---
    const state = {
        unlockedLevels: [1],
        completedLevels: []
    };

    const challenges = {
        1: {
            form: document.getElementById('form-1'),
            inputs: [document.getElementById('input-1-user'), document.getElementById('input-1-pass')],
            resultEl: document.getElementById('result-1'),
            buildQuery: (vals) => `SELECT * FROM users WHERE username = '${vals[0]}' AND password = '${vals[1]}';`,
            checkSuccess: (vals) => {
                // Permitir variantes como: admin' OR '1'='1--
                const pattern = /(('|\")?\s*or\s*('1'='1|1=1|true)(--)?)/i;
                return pattern.test(vals[0]) || pattern.test(vals[1]);
            },
            analyze: (vals) => {
                const injectionPattern = /'\s*or\s*('[^']*'='\d+'|\d+=\d+|true)/i;
                const userInjection = vals[0].match(injectionPattern);
                const passInjection = vals[1].match(injectionPattern);
                const injection = userInjection || passInjection;
                const comment = vals[0].includes('--') || vals[1].includes('--');
                
                if (injection) {
                    const fieldName = userInjection ? 'usuario' : 'contraseña';
                    let analysis = `<div class="space-y-2">
                        <div class="text-red-400 font-bold">🔍 INYECCIÓN BOOLEANA DETECTADA</div>
                        <div class="text-sm">La inyección <span class="sql-red font-mono">' OR 1=1'</span> en el campo ${fieldName} rompe la lógica de autenticación:</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Consulta original: WHERE username = '${vals[0]}' AND password = '${vals[1]}'</div>
                            <div class="text-red-300">Resultado: La condición WHERE se vuelve TRUE porque '1=1' siempre es verdadero</div>
                        </div>
                        <div class="text-sm">Como <code>'1=1'</code> siempre es <span class="text-green-400">TRUE</span>, toda la condición WHERE es verdadera.</div>`;
                    
                    if (comment) {
                        analysis += `<div class="text-sm">El comentario <span class="sql-gray font-mono">--</span> ignora el resto de la consulta, evitando errores de sintaxis.</div>`;
                    }
                    
                    analysis += `</div>`;
                    return analysis;
                }
                
                if (vals[0].includes("'") || vals[1].includes("'")) {
                    return '<div class="text-yellow-400">Se detectan comillas en la entrada. Esto podría ser el inicio de una inyección SQL. Intenta agregar una condición que siempre sea verdadera.</div>';
                }
                
                return '<div class="text-gray-400">No se detectó una inyección booleana. El objetivo es hacer que la condición WHERE siempre sea verdadera usando <code>\' OR \'1\'=\'1</code>.</div>';
            }
        },
        2: {
            form: document.getElementById('form-2'),
            inputs: [document.getElementById('input-2-search')],
            resultEl: document.getElementById('result-2'),
            buildQuery: (vals) => `SELECT name, description FROM products WHERE name LIKE '%${vals[0]}%';`,
            checkSuccess: (vals) => vals[0].toLowerCase().includes("union select"),
            analyze: (vals) => {
                const injection = vals[0].match(/union\s+select\s+username,\s*password\s+from\s+users/i);
                if (injection) {
                    return `<div class="space-y-2">
                        <div class="text-red-400 font-bold">🔍 ATAQUE UNION DETECTADO</div>
                        <div class="text-sm">El ataque <span class="sql-red font-mono">UNION SELECT</span> permite combinar resultados de dos consultas:</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Consulta original: SELECT name, description FROM products WHERE name LIKE '%[input]%'</div>
                            <div class="text-red-300">Consulta inyectada: SELECT name, description FROM products WHERE name LIKE '%' UNION SELECT username, password FROM users%'</div>
                        </div>
                        <div class="text-sm">Esto expone datos sensibles de la tabla <span class="sql-table font-mono">users</span>, mostrando nombres de usuario y contraseñas.</div>
                        <div class="text-sm text-yellow-300">⚠️ En un ataque real, esto comprometería toda la base de datos de usuarios.</div>
                    </div>`;
                }
                
                if (vals[0].toLowerCase().includes("union")) {
                    return '<div class="text-yellow-400">Se detectó la palabra clave UNION. Asegúrate de que el número de columnas coincida con la consulta original (2 columnas en este caso).</div>';
                }
                
                if (vals[0].includes("'")) {
                    return '<div class="text-yellow-400">Se detectan comillas. Para un ataque UNION, necesitas cerrar la cadena y luego añadir tu consulta SELECT.</div>';
                }
                
                return '<div class="text-gray-400">No se detectó un ataque UNION. El objetivo es añadir una segunda consulta SELECT para extraer datos de la tabla <code>users</code>.</div>';
            }
        },
        3: {
            form: document.getElementById('form-3'),
            inputs: [document.getElementById('input-3-coupon')],
            resultEl: document.getElementById('result-3'),
            buildQuery: (vals) => `SELECT discount FROM coupons WHERE code = '${vals[0]}';`,
            checkSuccess: (vals) => {
                const match = vals[0].match(/sleep\((\d+)\)/i);
                return match && parseInt(match[1], 10) > 0;
            },
            analyze: (vals) => {
                const injection = vals[0].match(/sleep\(\d+\)/i);
                if (injection) {
                    const seconds = injection[0].match(/\d+/)[0];
                    return `<div class="space-y-2">
                        <div class="text-red-400 font-bold">🔍 INYECCIÓN BASADA EN TIEMPO DETECTADA</div>
                        <div class="text-sm">La función <span class="sql-red font-mono">SLEEP(${seconds})</span> ordena a la base de datos esperar ${seconds} segundos:</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Consulta original: SELECT discount FROM coupons WHERE code = '[input]'</div>
                            <div class="text-red-300">Consulta inyectada: SELECT discount FROM coupons WHERE code = '' AND SLEEP(${seconds})--'</div>
                        </div>
                        <div class="text-sm">Si la página tarda ${seconds} segundos extra en cargar, has confirmado la vulnerabilidad.</div>
                        <div class="text-sm text-yellow-300">⚠️ Este tipo de ataque es útil cuando no puedes ver errores o datos directamente.</div>
                    </div>`;
                }
                return '<div class="text-gray-400">No se detectó una inyección basada en tiempo. El objetivo es inyectar una función que pause la ejecución de la base de datos, como <code>SLEEP(seconds)</code>.</div>';
            }
        },
        4: {
            form: document.getElementById('form-4'),
            inputs: [document.getElementById('input-4-search')],
            resultEl: document.getElementById('result-4'),
            buildQuery: (vals) => `SELECT name, description FROM products WHERE name LIKE '%${vals[0]}%';`,
            checkSuccess: (vals) => /information_schema/i.test(vals[0]) && /(select|floor|rand|count)/i.test(vals[0]),
            analyze: (vals) => {
                if (/information_schema/i.test(vals[0]) && /(select|floor|rand|count)/i.test(vals[0])) {
                    return `<div class="space-y-2">
                        <div class="text-purple-400 font-bold">🔍 INYECCIÓN BASADA EN ERRORES DETECTADA</div>
                        <div class="text-sm">Has usado <span class="sql-red font-mono">information_schema</span> junto con funciones que pueden provocar errores controlados.</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Payload: ${vals[0]}</div>
                        </div>
                        <div class="text-sm text-yellow-300">⚠️ Los errores de MySQL pueden revelar nombres de bases de datos, tablas y otra información sensible.</div>
                    </div>`;
                }
                if (/information_schema/i.test(vals[0])) {
                    return '<div class="text-yellow-400">Detectado <code>information_schema</code>. Necesitas añadir funciones que provoquen errores como <code>FLOOR(RAND()*2)</code> y <code>COUNT(*)</code>.</div>';
                }
                return '<div class="text-gray-400">El objetivo es provocar un error de MySQL que revele información. Usa <code>information_schema</code> con subconsultas que generen duplicados.</div>';
            }
        },
        5: {
            form: document.getElementById('form-5'),
            inputs: [document.getElementById('input-5-order')],
            resultEl: document.getElementById('result-5'),
            buildQuery: (vals) => `SELECT name, description FROM products ORDER BY ${vals[0]};`,
            checkSuccess: (vals) => /(select.*from.*users|;.*select|\(.*select.*union)/i.test(vals[0]),
            analyze: (vals) => {
                if (/(select.*from.*users|;.*select|\(.*select.*union)/i.test(vals[0])) {
                    return `<div class="space-y-2">
                        <div class="text-pink-400 font-bold">🔍 INYECCIÓN EN ORDER BY DETECTADA</div>
                        <div class="text-sm">Has inyectado SQL en el parámetro ORDER BY para ejecutar consultas adicionales o provocar errores.</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>ORDER BY ${vals[0]}</div>
                        </div>
                        <div class="text-sm text-yellow-300">⚠️ En sistemas reales, esto puede permitir la extracción de datos o ejecución de comandos arbitrarios.</div>
                    </div>`;
                }
                if (/;|union|select/i.test(vals[0])) {
                    return '<div class="text-yellow-400">Detectadas palabras clave SQL. Intenta combinarlas para crear una inyección más compleja que extraiga datos de la tabla users.</div>';
                }
                return '<div class="text-gray-400">El parámetro ORDER BY puede ser vulnerable. Intenta inyectar SQL usando <code>;</code> seguido de consultas o subconsultas con <code>UNION SELECT</code>.</div>';
            }
        },
        6: {
            form: document.getElementById('form-6'),
            inputs: [document.getElementById('input-6-check')],
            resultEl: document.getElementById('result-6'),
            buildQuery: (vals) => `SELECT * FROM users WHERE username = '${vals[0]}' OR (SELECT COUNT(*) FROM users WHERE username = '${vals[0]}') > 0;`,
            checkSuccess: (vals) => /(select.*count.*from.*users|where.*username.*and.*password)/i.test(vals[0]),
            analyze: (vals) => {
                if (/(select.*count.*from.*users|where.*username.*and.*password)/i.test(vals[0])) {
                    return `<div class="space-y-2">
                        <div class="text-indigo-400 font-bold">🔍 INYECCIÓN EN SUBCONSULTA DETECTADA</div>
                        <div class="text-sm">Has inyectado una subconsulta que puede saltarse la validación del sistema.</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Subconsulta: ${vals[0]}</div>
                        </div>
                        <div class="text-sm text-yellow-300">⚠️ Las subconsultas maliciosas pueden forzar condiciones TRUE y obtener acceso no autorizado.</div>
                    </div>`;
                }
                if (/select.*count/i.test(vals[0])) {
                    return '<div class="text-yellow-400">Detectado <code>SELECT COUNT</code>. Intenta añadir condiciones <code>WHERE</code> que siempre sean verdaderas para forzar el resultado.</div>';
                }
                return '<div class="text-gray-400">El objetivo es inyectar una subconsulta que devuelva TRUE. Usa <code>SELECT COUNT(*) FROM users WHERE</code> con condiciones siempre verdaderas.</div>';
            }
        }
    };

    // --- SIMULACIÓN DE LA BASE DE DATOS ---
    const db = {
        users: [
            { id: 1, username: 'admin', password: 'ultra-secret-password-123' },
            { id: 2, username: 'juan', password: 'password123' },
            { id: 3, username: 'ana', password: 'qwerty' }
        ],
        products: [
            { id: 1, name: 'Laptop Pro', description: 'Potente laptop para profesionales.' },
            { id: 2, name: 'Teclado Mecánico RGB', description: 'Teclado con switches cherry-mx.' }
        ]
    };

    // --- LÓGICA PRINCIPAL ---
    document.addEventListener('DOMContentLoaded', () => {
        updateUI();
        Object.keys(challenges).forEach(key => {
            const id = parseInt(key, 10);
            const challenge = challenges[id];
            
            challenge.inputs.forEach(input => {
                input.addEventListener('input', () => handleRealtimeUpdate(id));
            });

            challenge.form.addEventListener('submit', (e) => {
                e.preventDefault();
                console.log(`Submit for challenge ${id}`); // Depuración
                handleSubmit(id);
            });
        });
    });

    function handleRealtimeUpdate(id) {
        if (!state.unlockedLevels.includes(id)) return;
        const challenge = challenges[id];
        const values = challenge.inputs.map(i => i.value);
        const query = challenge.buildQuery(values);
        displayQuery(query);

        const analysis = challenge.analyze(values);
        document.getElementById('analysis-content').innerHTML = analysis;
        
        // Ajustar altura dinámicamente
        adjustAnalysisPanelHeight();
    }

    function adjustAnalysisPanelHeight() {
        const analysisContent = document.getElementById('analysis-content');
        if (analysisContent) {
            // Resetear altura para obtener el scroll height natural
            analysisContent.style.maxHeight = 'none';
            analysisContent.style.height = 'auto';
            
            // Obtener la altura del contenido
            const scrollHeight = analysisContent.scrollHeight;
            const currentHeight = analysisContent.clientHeight;
            
            // Si el contenido es muy largo, establecer un máximo razonable
            if (scrollHeight > 400) {
                analysisContent.style.maxHeight = '400px';
                analysisContent.style.overflowY = 'auto';
            } else {
                // Si es contenido corto, permitir que se expanda naturalmente
                analysisContent.style.maxHeight = 'none';
                analysisContent.style.overflowY = 'visible';
                analysisContent.style.height = `${Math.max(scrollHeight, 80)}px`;
            }
        }
    }

    function handleSubmit(id) {
        console.log(`Submit for challenge ${id}`); // Depuración
        if (!state.unlockedLevels.includes(id)) return;
        const challenge = challenges[id];
        const values = challenge.inputs.map(i => i.value);
        const isSuccess = challenge.checkSuccess(values);

        switch(id) {
            case 1:
                handleLoginSubmit(isSuccess);
                break;
            case 2:
                handleSearchSubmit(isSuccess, values[0]);
                break;
            case 3:
                handleCouponSubmit(isSuccess, values[0]);
                break;
            case 4:
                handleErrorSubmit(isSuccess, values[0]);
                break;
            case 5:
                handleOrderSubmit(isSuccess, values[0]);
                break;
            case 6:
                handleSubquerySubmit(isSuccess, values[0]);
                break;
        }

        if (isSuccess && !state.completedLevels.includes(id)) {
            state.completedLevels.push(id);
            const nextLevel = id + 1;
            if (challenges[nextLevel] && !state.unlockedLevels.includes(nextLevel)) {
                state.unlockedLevels.push(nextLevel);
                showToast(`¡Felicidades! Has desbloqueado el Nivel ${nextLevel}.`);
            }
            updateUI();
        }
    }

    // --- MANEJADORES DE RESULTADOS ---
    function handleLoginSubmit(isSuccess) {
        const resultEl = challenges[1].resultEl;
        if (isSuccess) {
            resultEl.innerHTML = `✅ ¡Acceso concedido! Has entrado como <strong>admin</strong>. La puerta al siguiente nivel está abierta.`;
            resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200';
        } else {
            resultEl.innerHTML = `❌ Acceso denegado. Usuario o contraseña incorrectos. ¡Sigue intentando!`;
            resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200';
        }
    }

    function handleSearchSubmit(isSuccess, searchTerm) {
        const resultEl = challenges[2].resultEl;
        resultEl.innerHTML = '';
        if (isSuccess) {
            resultEl.innerHTML = `<div class="p-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 text-sm"><strong>¡PELIGRO!</strong> Se han extraído datos sensibles de la tabla de usuarios.</div>`;
            db.users.forEach(user => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow';
                itemEl.innerHTML = `<h4 class="font-bold text-red-400">${user.username}</h4><p class="text-sm text-red-400 font-fira">${user.password}</p>`;
                resultEl.appendChild(itemEl);
            });
        } else {
            const results = db.products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            if (results.length > 0) {
                 results.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow';
                    itemEl.innerHTML = `<h4 class="font-bold">${item.name}</h4><p class="text-sm text-gray-600 dark:text-gray-400">${item.description}</p>`;
                    resultEl.appendChild(itemEl);
                });
            } else {
                 resultEl.innerHTML = `<div class="p-3 text-center text-gray-500">No se encontraron productos.</div>`;
            }
        }
    }
    
    function handleCouponSubmit(isSuccess, couponCode) {
        const resultEl = challenges[3].resultEl;
        const match = couponCode.match(/sleep\((\d+)\)/i);
        const delay = isSuccess ? parseInt(match[1], 10) * 1000 : 0;

        resultEl.innerHTML = `Validando cupón... <div class="w-4 h-4 border-2 border-dashed rounded-full animate-spin border-blue-500"></div>`;
        resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-gray-100 dark:bg-gray-700 flex items-center gap-2';
        
        setTimeout(() => {
            if (isSuccess) {
                resultEl.innerHTML = `✅ ¡Éxito! El servidor tardó ${delay/1000} segundos en responder. Has confirmado una inyección a ciegas.`;
                resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200';
            } else {
                resultEl.innerHTML = `❌ El cupón no es válido y el servidor respondió instantáneamente. No se detectó retraso.`;
                resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200';
            }
        }, delay);
    }

    function handleErrorSubmit(isSuccess, searchTerm) {
        const resultEl = challenges[4].resultEl;
        resultEl.innerHTML = '';
        if (isSuccess) {
            // Simular error de MySQL que revela información
            resultEl.innerHTML = `<div class="p-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 text-sm">
                <strong>ERROR MySQL:</strong> Duplicate entry 'shopdb:1' for key 'group_key'<br>
                <span class="text-xs">Query: SELECT name, description FROM products WHERE name LIKE '%${searchTerm}%'</span>
            </div>
            <div class="mt-2 p-3 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 text-sm">
                ✅ <strong>¡Éxito!</strong> El error reveló que la base de datos se llama <strong>"shopdb"</strong>. En un ataque real, podrías extraer más información sensible.
            </div>`;
        } else {
            const results = db.products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            if (results.length > 0) {
                results.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow';
                    itemEl.innerHTML = `<h4 class="font-bold">${item.name}</h4><p class="text-sm text-gray-600 dark:text-gray-400">${item.description}</p>`;
                    resultEl.appendChild(itemEl);
                });
            } else {
                resultEl.innerHTML = `<div class="p-3 text-center text-gray-500">No se encontraron productos.</div>`;
            }
        }
    }

    function handleOrderSubmit(isSuccess, orderField) {
        const resultEl = challenges[5].resultEl;
        resultEl.innerHTML = '';
        if (isSuccess) {
            resultEl.innerHTML = `<div class="p-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 text-sm">
                <strong>ERROR MySQL:</strong> You have an error in your SQL syntax near '${orderField}' at line 1<br>
                <span class="text-xs">Query: SELECT name, description FROM products ORDER BY ${orderField}</span>
            </div>
            <div class="mt-2 p-3 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 text-sm">
                ✅ <strong>¡Éxito!</strong> Has manipulado el ORDER BY y provocado un error. En un sistema real, podrías usar esto para extraer datos o ejecutar comandos adicionales.
            </div>`;
        } else {
            // Mostrar productos ordenados normalmente
            let sortedProducts = [...db.products];
            if (orderField.toLowerCase() === 'name') {
                sortedProducts.sort((a, b) => a.name.localeCompare(b.name));
            } else if (orderField.toLowerCase() === 'description') {
                sortedProducts.sort((a, b) => a.description.localeCompare(b.description));
            }
            
            sortedProducts.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow';
                itemEl.innerHTML = `<h4 class="font-bold">${item.name}</h4><p class="text-sm text-gray-600 dark:text-gray-400">${item.description}</p>`;
                resultEl.appendChild(itemEl);
            });
        }
    }

    function handleSubquerySubmit(isSuccess, checkValue) {
        const resultEl = challenges[6].resultEl;
        if (isSuccess) {
            resultEl.innerHTML = `✅ <strong>¡Acceso concedido!</strong> La subconsulta maliciosa devolvió TRUE, saltándose la validación del sistema.`;
            resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200';
        } else {
            resultEl.innerHTML = `❌ Valor no válido. El sistema no pudo encontrar coincidencias para "${checkValue}".`;
            resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200';
        }
    }

    // --- FUNCIONES DE UI ---
    function updateUI() {
        Object.keys(challenges).forEach(key => {
            const id = parseInt(key, 10);
            const card = document.getElementById(`challenge-${id}`);
            if (state.unlockedLevels.includes(id)) {
                card.classList.remove('locked');
                card.style.pointerEvents = 'auto';
            } else {
                card.classList.add('locked');
                card.style.pointerEvents = 'none';
            }
            if(state.completedLevels.includes(id)) {
                card.classList.add('completed');
                card.classList.remove('border-blue-500', 'border-gray-500');
            }
        });
        
        const progress = (state.completedLevels.length / Object.keys(challenges).length) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        
        const progressTextEl = document.getElementById('progress-text');
        const totalLevels = Object.keys(challenges).length;
        const completedCount = state.completedLevels.length;
        
        if (completedCount === 0) {
            progressTextEl.textContent = `0% completado - ¡Comienza tu aventura!`;
        } else if (completedCount === totalLevels) {
            progressTextEl.textContent = `🎉 100% completado - ¡Eres un experto en SQLi!`;
        } else {
            progressTextEl.textContent = `${Math.round(progress)}% completado - Nivel ${completedCount} de ${totalLevels} completo`;
        }
    }

    function displayQuery(query) {
        let highlightedQuery = query;

        // Separar comentarios primero
        const commentMatch = query.match(/(--.*)$/);
        let commentPart = '';
        let queryPart = query;
        if (commentMatch) {
            commentPart = `<span class="sql-gray">${commentMatch[0]}</span>`;
            queryPart = query.substring(0, query.indexOf(commentMatch[0]));
        }

        // Resaltar inyecciones, cadenas y palabras clave en la parte no comentada
        const regex = /(' OR '1'='1|UNION\s+SELECT|SLEEP\(\d+\))|('[^']*')|(\bSELECT\b|\bFROM\b|\bWHERE\b|\bAND\b)/gi;
        highlightedQuery = queryPart.replace(regex, (match, injection, string, keyword) => {
            if (injection) return `<span class="sql-red">${injection}</span>`;
            if (string) return `<span class="sql-green">${string}</span>`;
            if (keyword) return `<span class="sql-blue">${keyword}</span>`;
            return match;
        }) + commentPart;

        // Mostrar la consulta resaltada
        document.getElementById('sql-query-display').innerHTML = highlightedQuery || '<span class="text-gray-300">// Esperando una interacción...</span>';

        // Detectar vulnerabilidad (insensible a mayúsculas)
        let detectedInjection = null;
        const lowerQuery = query.toLowerCase();
        if (lowerQuery.includes("' or '1'='1") || lowerQuery.includes("' or 1=1")) {
            detectedInjection = { type: 'Inyección Booleana Clásica', danger: 'vuln-danger' };
        } else if (lowerQuery.includes("union select")) {
            detectedInjection = { type: 'Ataque UNION SELECT', danger: 'vuln-danger' };
        } else if (lowerQuery.includes("sleep(")) {
            detectedInjection = { type: 'Inyección Basada en Tiempo', danger: 'vuln-danger' };
        }

        const statusEl = document.getElementById('vulnerability-status');
        const typeEl = document.getElementById('injection-type');
        if (detectedInjection) {
            statusEl.textContent = 'VULNERABLE';
            statusEl.className = `vulnerability-indicator ${detectedInjection.danger}`;
            typeEl.textContent = detectedInjection.type;
        } else if (query.includes("'") || query.includes('"')) {
            statusEl.textContent = 'SOSPECHOSA';
            statusEl.className = 'vulnerability-indicator vuln-warning';
            typeEl.textContent = 'Entrada con comillas detectada';
        } else {
            statusEl.textContent = 'SEGURA';
            statusEl.className = 'vulnerability-indicator vuln-safe';
            typeEl.textContent = '';
        }

        // Actualizar vista paso a paso
        mostrarHTMLFormulario(query);
        updateQueryBreakdown(query, detectedInjection);
        
        // Ajustar altura del panel de análisis si existe contenido
        setTimeout(adjustAnalysisPanelHeight, 100);
    }

    function mostrarHTMLFormulario(query) {
        const stepEl = document.getElementById('sql-query-step');
        
        // Detectar el tipo de consulta para mostrar el formulario adecuado
        if (/FROM\s+users/i.test(query) && /username\s*=\s*'[^']*'/.test(query)) {
            // Formulario de login (Retos 1-2)
            let userMatch = query.match(/username\s*=\s*'([^']*)'/i);
            let passMatch = query.match(/password\s*=\s*'([^']*)'/i);
            let user = userMatch ? userMatch[1] : '';
            let pass = passMatch ? passMatch[1] : '';
            let inyeccion = /(' OR '1'='1|UNION\s+SELECT|SLEEP\()/i.test(user);
            let inyeccionPass = /(' OR '1'='1|UNION\s+SELECT|SLEEP\()/i.test(pass);
            let userHtml = inyeccion ? `<span class='sql-red'>${user}</span>` : `<span class='sql-green'>${user}</span>`;
            let passHtml = inyeccionPass ? `<span class='sql-red'>${pass}</span>` : `<span class='sql-green'>${pass}</span>`;
            let html = `<form>\n  <input type="text" name="username" value="${userHtml}" />\n  <input type="password" name="password" value="${passHtml}" />\n  <button>Login</button>\n</form>`;
            stepEl.textContent = html;
        } else if (/FROM\s+products/i.test(query) && (/name LIKE '%[^%]*%'/i.test(query) || /ORDER BY/i.test(query))) {
            // Formulario de búsqueda de productos (Retos 2-5)
            let searchMatch = query.match(/name LIKE '%([^%]*)%'/i);
            let orderMatch = query.match(/ORDER BY\s+([^LIMIT;]+)/i);
            let limitMatch = query.match(/LIMIT\s+([^;]+)/i);
            
            let search = searchMatch ? searchMatch[1] : '';
            let orderBy = orderMatch ? orderMatch[1].trim() : '';
            let limit = limitMatch ? limitMatch[1].trim() : '';
            
            // Detectar inyecciones
            let searchInjection = /(UNION\s+SELECT|SLEEP\(|information_schema)/i.test(search);
            let orderInjection = /(SLEEP\(|information_schema|UNION|SELECT)/i.test(orderBy);
            let limitInjection = /(SLEEP\(|UNION|SELECT)/i.test(limit);
            
            let searchHtml = searchInjection ? `<span class='sql-red'>${search}</span>` : `<span class='sql-green'>${search}</span>`;
            let orderHtml = orderInjection ? `<span class='sql-red'>${orderBy}</span>` : `<span class='sql-green'>${orderBy}</span>`;
            let limitHtml = limitInjection ? `<span class='sql-red'>${limit}</span>` : `<span class='sql-green'>${limit}</span>`;
            
            let html = `<form>\n  <input type="text" name="search" value="${searchHtml}" placeholder="Buscar producto..." />`;
            if (orderBy) html += `\n  <input type="hidden" name="sort" value="${orderHtml}" />`;
            if (limit) html += `\n  <input type="hidden" name="limit" value="${limitHtml}" />`;
            html += `\n  <button>Buscar</button>\n</form>`;
            stepEl.textContent = html;
        } else if (/FROM\s+coupons/i.test(query) && /code\s*=\s*'[^']*'/.test(query)) {
            // Formulario de cupón (Reto 3)
            let couponMatch = query.match(/code\s*=\s*'([^']*)'/i);
            let coupon = couponMatch ? couponMatch[1] : '';
            let inyeccion = /(SLEEP\()/i.test(coupon);
            let couponHtml = inyeccion ? `<span class='sql-red'>${coupon}</span>` : `<span class='sql-green'>${coupon}</span>`;
            let html = `<form>\n  <input type="text" name="coupon" value="${couponHtml}" />\n  <button>Validar</button>\n</form>`;
            stepEl.textContent = html;
        } else if (/FROM\s+information_schema/i.test(query)) {
            // Consulta de metadatos (Reto 4-6)
            let tableMatch = query.match(/FROM\s+(information_schema\.\w+)/i);
            let whereMatch = query.match(/WHERE\s+(.+?)(?:ORDER BY|LIMIT|;|$)/i);
            
            let table = tableMatch ? tableMatch[1] : '';
            let whereClause = whereMatch ? whereMatch[1].trim() : '';
            
            let tableHtml = `<span class='sql-red'>${table}</span>`;
            let whereHtml = whereClause ? `<span class='sql-red'>${whereClause}</span>` : '';
            
            let html = `<div class="meta-query">\n  <p>🔍 Consulta de metadatos detectada:</p>\n  <p>Tabla: ${tableHtml}</p>`;
            if (whereHtml) html += `\n  <p>Filtro: ${whereHtml}</p>`;
            html += `\n</div>`;
            stepEl.innerHTML = html;
        } else if (/SELECT.*FROM.*WHERE/i.test(query) && (/UNION|SELECT.*\(SELECT/i.test(query))) {
            // Consultas complejas con UNION o subconsultas (Reto 6)
            let parts = query.split(/UNION/i);
            let html = `<div class="complex-query">\n  <p>🔗 Consulta compuesta detectada:</p>`;
            
            parts.forEach((part, index) => {
                let isInjection = /information_schema|SELECT.*\(SELECT/i.test(part);
                let partClass = isInjection ? 'sql-red' : 'sql-blue';
                html += `\n  <p>Parte ${index + 1}: <span class='${partClass}'>${part.trim()}</span></p>`;
            });
            
            html += `\n</div>`;
            stepEl.innerHTML = html;
        } else {
            stepEl.textContent = '// Esperando una interacción...';
        }
    }

    function toggleHint(id) {
        const hintEl = document.getElementById(`hint-${id}`);
        if (hintEl) {
            hintEl.classList.toggle('hidden');
        }
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        if (toastMessage) {
            toastMessage.textContent = message;
        } else {
            toast.textContent = message;
        }
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function updateQueryBreakdown(query, detectedInjection) {
        const breakdownEl = document.getElementById('breakdown-content');
        let breakdown = '<div class="space-y-2 text-xs">';
        
        // Análisis más específico para diferentes tipos de consultas
        let parts = {};
        
        // Identificar tipo de consulta y extraer partes
        if (/SELECT.*FROM.*WHERE/i.test(query)) {
            // Consulta SELECT típica
            parts.select = query.match(/SELECT\s+([^FROM]+)/i)?.[1]?.trim() || '';
            parts.from = query.match(/FROM\s+(\w+)/i)?.[1] || '';
            parts.where = query.match(/WHERE\s+(.+?)(?:ORDER BY|LIMIT|;|$)/i)?.[1]?.trim() || '';
            parts.orderBy = query.match(/ORDER BY\s+([^LIMIT;]+)/i)?.[1]?.trim() || '';
            parts.limit = query.match(/LIMIT\s+([^;]+)/i)?.[1]?.trim() || '';
        } else if (/SELECT.*FROM/i.test(query)) {
            // Consulta SELECT sin WHERE
            parts.select = query.match(/SELECT\s+([^FROM]+)/i)?.[1]?.trim() || '';
            parts.from = query.match(/FROM\s+(\w+)/i)?.[1] || '';
            parts.orderBy = query.match(/ORDER BY\s+([^LIMIT;]+)/i)?.[1]?.trim() || '';
            parts.limit = query.match(/LIMIT\s+([^;]+)/i)?.[1]?.trim() || '';
        }
        
        // Mostrar partes de la consulta
        if (parts.select) {
            // Resaltar SELECT maliciosos
            let selectHtml = parts.select;
            if (/UNION\s+SELECT/i.test(query)) {
                selectHtml = selectHtml.replace(/(UNION\s+SELECT[^,]*)/gi, '<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">$1</span>');
            }
            breakdown += `<div><span class="text-blue-400 font-bold">SELECT:</span> <span class="text-gray-300">${selectHtml}</span></div>`;
        }
        
        if (parts.from) {
            // Resaltar tablas sensibles
            let fromHtml = parts.from;
            if (/information_schema/i.test(parts.from)) {
                fromHtml = `<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">${parts.from}</span>`;
            }
            breakdown += `<div><span class="text-green-400 font-bold">FROM:</span> <span class="text-cyan-300">${fromHtml}</span></div>`;
        }
        
        if (parts.where) {
            // Resaltar payloads maliciosos en WHERE
            let whereHtml = parts.where;
            whereHtml = whereHtml.replace(/(OR\s+'1'='1'|OR\s+1=1|SLEEP\([^)]*\)|information_schema)/gi, '<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">$1</span>');
            breakdown += `<div><span class="text-yellow-400 font-bold">WHERE:</span> <span class="text-gray-300">${whereHtml}</span></div>`;
        }
        
        if (parts.orderBy) {
            // Resaltar ORDER BY maliciosos
            let orderByHtml = parts.orderBy;
            if (/SLEEP\(|information_schema|UNION|SELECT/i.test(parts.orderBy)) {
                orderByHtml = orderByHtml.replace(/(SLEEP\([^)]*\)|information_schema|UNION[^,]*|SELECT[^,]*)/gi, '<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">$1</span>');
            }
            breakdown += `<div><span class="text-purple-400 font-bold">ORDER BY:</span> <span class="text-gray-300">${orderByHtml}</span></div>`;
        }
        
        if (parts.limit) {
            breakdown += `<div><span class="text-indigo-400 font-bold">LIMIT:</span> <span class="text-gray-300">${parts.limit}</span></div>`;
        }
        
        // Análisis de inyección específico
        if (detectedInjection) {
            breakdown += '<div class="mt-3 p-3 bg-red-900/30 rounded border border-red-500">';
            breakdown += '<div class="text-red-400 font-bold text-sm mb-2">⚠️ INYECCIÓN DETECTADA</div>';
            
            switch(detectedInjection.type) {
                case 'Inyección Booleana Clásica':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>Técnica:</strong> Manipulación de condiciones lógicas</div>';
                    breakdown += '<div class="text-red-300 text-xs">• La condición <code>OR \'1\'=\'1\'</code> siempre es verdadera</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Esto bypassa la autenticación completamente</div>';
                    break;
                case 'Ataque UNION SELECT':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>Técnica:</strong> Combinación de consultas</div>';
                    breakdown += '<div class="text-red-300 text-xs">• <code>UNION SELECT</code> combina resultados de múltiples consultas</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Permite extraer datos de otras tablas</div>';
                    break;
                case 'Inyección Basada en Tiempo':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>Técnica:</strong> Análisis temporal</div>';
                    breakdown += '<div class="text-red-300 text-xs">• <code>SLEEP()</code> introduce retrasos medibles</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Confirma vulnerabilidad sin mostrar datos</div>';
                    break;
                case 'Inyección Basada en Errores':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>Técnica:</strong> Extracción por errores</div>';
                    breakdown += '<div class="text-red-300 text-xs">• <code>information_schema</code> contiene metadatos del sistema</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Los errores SQL pueden revelar estructura de BD</div>';
                    break;
                case 'Inyección en ORDER BY/LIMIT':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>Técnica:</strong> Manipulación de ordenamiento</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Inyección en cláusulas de ordenamiento</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Puede provocar errores informativos</div>';
                    break;
                case 'Inyección en Subconsulta':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>Técnica:</strong> Consultas anidadas</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Subconsultas pueden filtrar información</div>';
                    breakdown += '<div class="text-red-300 text-xs">• Bypass de validaciones superficiales</div>';
                    break;
            }
            breakdown += '</div>';
        } else if (query.includes("'") || query.includes('"')) {
            breakdown += '<div class="mt-3 p-3 bg-yellow-900/30 rounded border border-yellow-500">';
            breakdown += '<div class="text-yellow-400 font-bold text-sm mb-1">⚠️ PRECAUCIÓN</div>';
            breakdown += '<div class="text-yellow-300 text-xs">Se detectan comillas en la entrada. Usar parámetros preparados previene inyecciones.</div>';
            breakdown += '</div>';
        }
        
        breakdown += '</div>';
        breakdownEl.innerHTML = breakdown;
    }

    </script>
</body>
</html>