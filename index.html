<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio de Hacking: Inyecci√≥n SQL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-fira { font-family: 'Fira Code', monospace; }
        .sql-blue { color: #569cd6; font-weight: bold; }
        .sql-green { color: #ce9178; font-weight: 500; }
        .sql-red { 
            background-color: rgba(255, 40, 40, 0.6) !important; 
            border-radius: 6px; 
            padding: 3px 6px !important; 
            border: 2px solid #ff3333 !important;
            position: relative;
            font-weight: bold !important;
            color: #ffffff !important;
            text-shadow: 0 0 4px rgba(255, 0, 0, 0.8);
            box-shadow: 0 0 8px rgba(255, 40, 40, 0.5);
            animation: pulseRed 2s infinite;
        }
        .sql-gray { color: #6a9955; font-weight: 500; }
        @keyframes pulseRed {
            0%, 100% { 
                background-color: rgba(255, 40, 40, 0.6);
                box-shadow: 0 0 8px rgba(255, 40, 40, 0.5);
            }
            50% { 
                background-color: rgba(255, 60, 60, 0.8);
                box-shadow: 0 0 12px rgba(255, 40, 40, 0.8);
            }
        }
        .sql-red::before {
            content: "‚ö†Ô∏è INYECCI√ìN";
            position: absolute;
            top: -22px;
            left: 0;
            font-size: 10px;
            background: #ff3333;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
            border: 1px solid #fff;
        }
        .query-structure {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            border-left: 4px solid #569cd6;
        }
        .meta-query {
            background: linear-gradient(135deg, rgba(255, 100, 100, 0.1), rgba(255, 150, 150, 0.05));
            border: 1px solid rgba(255, 100, 100, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        .meta-query p {
            margin: 4px 0;
            font-size: 0.9em;
        }
        .complex-query {
            background: linear-gradient(135deg, rgba(150, 100, 255, 0.1), rgba(200, 150, 255, 0.05));
            border: 1px solid rgba(150, 100, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
        }
        .complex-query p {
            margin: 4px 0;
            font-size: 0.9em;
        }
        .analysis-responsive {
            transition: all 0.3s ease;
            resize: vertical;
        }
        .vulnerability-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-left: 8px;
        }
        .vuln-safe { background: #22c55e; color: white; }
        .vuln-warning { background: #f59e0b; color: white; }
        .vuln-danger { background: #ef4444; color: white; }
        .smooth-scroll { scroll-behavior: smooth; }
        .challenge-card.locked {
            opacity: 0.6;
            background-color: #f3f4f6;
        }
        .challenge-card.locked .challenge-content {
            filter: blur(2px);
        }
        .challenge-card.completed {
            border-left-color: #22c55e;
        }
        .toast {
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .difficulty-star {
            color: #fbbf24;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        button:disabled:hover {
            background-color: inherit !important;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Notificaci√≥n Toast -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl z-50">
        <p id="toast-message">¬°Nivel desbloqueado!</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600 dark:text-blue-400">Laboratorio de Hacking: SQLi</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400">Completa los desaf√≠os para convertirte en un experto en Inyecci√≥n SQL.</p>
        </header>

        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mb-8">
            <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full relative overflow-hidden" style="width: 0%; transition: width 0.5s ease-in-out;">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-pulse"></div>
            </div>
        </div>
        <div class="text-center mb-4">
            <span id="progress-text" class="text-sm text-gray-600 dark:text-gray-400">0% completado - ¬°Comienza tu aventura!</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Panel Izquierdo: Desaf√≠os -->
            <div class="space-y-6">
                <h2 class="text-2xl font-bold">üéØ Desaf√≠os de Inyecci√≥n</h2>
                
                <!-- Desaf√≠o 1: Inyecci√≥n Cl√°sica -->
                <div id="challenge-1" class="challenge-card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold flex-1 mr-2">Nivel 1: El Login Roto</h3>
                        <div class="flex flex-col gap-2 sm:flex-row">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">‚≠ê Principiante</span>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Cl√°sica / Booleana</span>
                        </div>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">La p√°gina de login de "ShopSafe" es vulnerable. Tu misi√≥n: acceder como <code class="font-fira text-sm">'admin'</code> sin saber la contrase√±a.</p>
                        <form id="form-1" class="space-y-4 mt-4">
                            <input type="text" id="input-1-user" placeholder="Usuario" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2" value="admin">
                            <input type="password" id="input-1-pass" placeholder="Contrase√±a" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py button:hover="bg-blue-700" py-2 px-4 rounded-md hover:bg-blue-700">Intentar Inyecci√≥n</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(1)" class="text-sm text-blue-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-1" class="hidden mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 text-sm rounded">La petici√≥n SQL se origina de una concatenaci√≥n insegura de las entradas de un usuario remoto. Esta entrada est√° entre comillas simples, pero en caso de que la entrada tenga una comilla simple, esa cerrar√≠a el string. Como primera inyecci√≥n, es recomendable intentar <code class="font-fira bg-blue-200 dark:bg-blue-800 px-1 rounded">' -- </code>.</p>
                        <div id="result-1" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desaf√≠o 2: Ataque de UNION -->
                <div id="challenge-2" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-gray-500">
                     <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold flex-1 mr-2">Nivel 2: El Buscador Curioso</h3>
                        <div class="flex flex-col gap-2 sm:flex-row">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">‚≠ê‚≠ê Intermedio</span>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Ataque UNION</span>
                        </div>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">El buscador de productos es vulnerable. Usa un ataque <code class="font-fira">UNION</code> para extraer los nombres de usuario y contrase√±as de la tabla <code class="font-fira">'users'</code>.</p>
                        <form id="form-2" class="flex gap-2 mt-4">
                            <input type="text" id="input-2-search" placeholder="Buscar producto..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-md hover:bg-yellow-600">Buscar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(2)" class="text-sm text-yellow-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-2" class="hidden mt-2 p-2 bg-yellow-50 dark:bg-yellow-900/20 text-sm rounded">La consulta original selecciona 2 columnas. Es posible cerrar la cadena con <code class="font-fira bg-yellow-200 dark:bg-yellow-800 px-1 rounded">'</code> y luego unir una consulta que seleccione 2 columnas de la tabla <code class="font-fira bg-yellow-200 dark:bg-yellow-800 px-1 rounded">users</code>, como <code class="font-fira bg-yellow-200 dark:bg-yellow-800 px-1 rounded">username, password</code>.</p>
                        <div id="result-2" class="mt-4 space-y-2"></div>
                    </div>
                </div>

                <!-- Desaf√≠o 3: Inyecci√≥n a Ciegas -->
                <div id="challenge-3" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-gray-500">
                     <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold flex-1 mr-2">Nivel 3: El Cup√≥n Paciente</h3>
                        <div class="flex flex-col gap-2 sm:flex-row">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300">‚≠ê‚≠ê‚≠ê Avanzado</span>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">A Ciegas / Basada en Tiempo</span>
                        </div>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">No ver√°s un error ni datos, pero puedes confirmar la vulnerabilidad si el servidor tarda en responder. Inyecta un comando que cause un retraso de 3 segundos.</p>
                        <form id="form-3" class="flex gap-2 mt-4">
                            <input type="text" id="input-3-coupon" placeholder="C√≥digo de cup√≥n..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700">Validar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(3)" class="text-sm text-red-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-3" class="hidden mt-2 p-2 bg-red-50 dark:bg-red-900/20 text-sm rounded">Usar un payload que ejecute una funci√≥n de espera. Para esta demo, la funci√≥n se llama <code class="font-fira bg-red-200 dark:bg-red-800 px-1 rounded">SLEEP(seconds)</code>. Es recomendable probar con algo como <code class="font-fira bg-red-200 dark:bg-red-800 px-1 rounded">' AND SLEEP(3)--</code>.</p>
                        <div id="result-3" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desaf√≠o 4: Inyecci√≥n basada en errores -->
                <div id="challenge-4" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold flex-1 mr-2">Nivel 4: ¬°Provoca un Error!</h3>
                        <div class="flex flex-col gap-2 sm:flex-row">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300">‚≠ê‚≠ê‚≠ê Avanzado</span>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300">Error-Based</span>
                        </div>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">
                            El sistema muestra mensajes de error de la base de datos. Intenta provocar un error para revelar informaci√≥n sensible usando una inyecci√≥n en el campo de b√∫squeda.
                        </p>
                        <form id="form-4" class="flex gap-2 mt-4">
                            <input type="text" id="input-4-search" placeholder="Buscar producto..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-md hover:bg-purple-700">Buscar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(4)" class="text-sm text-purple-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-4" class="hidden mt-2 p-2 bg-purple-50 dark:bg-purple-900/20 text-sm rounded">
                            Los errores de MySQL a menudo revelan informaci√≥n valiosa. Es posible usar <code class="font-fira bg-purple-200 dark:bg-purple-800 px-1 rounded">information_schema</code> con una subconsulta que fuerce un error. Las funciones como <code class="font-fira bg-purple-200 dark:bg-purple-800 px-1 rounded">FLOOR(RAND()*2)</code> y <code class="font-fira bg-purple-200 dark:bg-purple-800 px-1 rounded">COUNT(*)</code> pueden ayudar.
                        </p>
                        <div id="result-4" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desaf√≠o 5: Inyecci√≥n en ORDER BY/LIMIT -->
                <div id="challenge-5" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-pink-500">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold flex-1 mr-2">Nivel 5: Manipula el Orden</h3>
                        <div class="flex flex-col gap-2 sm:flex-row">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">‚≠ê‚≠ê‚≠ê‚≠ê Experto</span>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-300">ORDER BY/LIMIT</span>
                        </div>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">
                            El sistema permite ordenar los resultados. Intenta manipular el par√°metro de orden para provocar un error o filtrar informaci√≥n.
                        </p>
                        <form id="form-5" class="flex gap-2 mt-4">
                            <input type="text" id="input-5-order" placeholder="Campo para ordenar (por ejemplo: name)" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-pink-600 text-white font-bold py-2 px-4 rounded-md hover:bg-pink-700">Ordenar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(5)" class="text-sm text-pink-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-5" class="hidden mt-2 p-2 bg-pink-50 dark:bg-pink-900/20 text-sm rounded">
                            En SQLite, el <code class="font-fira bg-pink-200 dark:bg-pink-800 px-1 rounded">ORDER BY</code> es menos flexible para inyecciones directas de <code class="font-fira bg-pink-200 dark:bg-pink-800 px-1 rounded">UNION SELECT</code> que en otros SGBD. Es posible provocar un error SQL con una subconsulta inv√°lida, o usar expresiones <code class="font-fira bg-pink-200 dark:bg-pink-800 px-1 rounded">CASE WHEN...END</code> para inferir datos alterando el orden. Un <code class="font-fira bg-pink-200 dark:bg-pink-800 px-1 rounded">UNION SELECT</code> que sea aceptado sint√°cticamente (aunque no muestre datos de otra tabla limpiamente) tambi√©n es una manipulaci√≥n v√°lida.
                        </p>
                        <div id="result-5" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

                <!-- Desaf√≠o 6: Inyecci√≥n en Subconsulta -->
                <div id="challenge-6" class="challenge-card locked bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border-l-4 border-indigo-500">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold flex-1 mr-2">Nivel 6: Subconsulta Maliciosa</h3>
                        <div class="flex flex-col gap-2 sm:flex-row">
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">‚≠ê‚≠ê Intermedio</span>
                            <span class="text-xs font-medium px-2.5 py-0.5 rounded bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300">Subconsulta</span>
                        </div>
                    </div>
                    <div class="challenge-content">
                        <p class="mt-2 text-gray-600 dark:text-gray-400">
                            El sistema usa una subconsulta para obtener un <code class="font-fira">owner_id</code> basado en tu entrada: <code class="font-fira">(SELECT id FROM users WHERE username = '[INPUT]' AND role='administrator')</code>. Intenta inyectar en el campo <code class="font-fira">[INPUT]</code> para que la subconsulta devuelva el <code class="font-fira">id</code> del administrador, incluso si no sabes su nombre de usuario.
                        </p>
                        <form id="form-6" class="flex gap-2 mt-4">
                            <input type="text" id="input-6-check" placeholder="Introduce un valor..." class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm bg-gray-50 dark:bg-gray-700 font-fira p-2">
                            <button type="submit" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-md hover:bg-indigo-700">Validar</button>
                        </form>
                        <div class="mt-2 text-right"><button onclick="toggleHint(6)" class="text-sm text-indigo-500 hover:underline">Necesito una pista</button></div>
                        <p id="hint-6" class="hidden mt-2 p-2 bg-indigo-50 dark:bg-indigo-900/20 text-sm rounded">
                            La subconsulta busca un <code class="font-fira bg-indigo-200 dark:bg-indigo-800 px-1 rounded">username</code> espec√≠fico Y que el <code class="font-fira bg-indigo-200 dark:bg-indigo-800 px-1 rounded">role</code> sea <code class="font-fira bg-indigo-200 dark:bg-indigo-800 px-1 rounded">'administrator'</code>. Es posible inyectar algo como <code class="font-fira bg-indigo-200 dark:bg-indigo-800 px-1 rounded">x' OR 1=1 --</code> para hacer que toda la condici√≥n sea verdadera, o <code class="font-fira bg-indigo-200 dark:bg-indigo-800 px-1 rounded">x' OR username='admin' --</code> si se conoce el nombre del administrador.
                        </p>
                        <div id="result-6" class="mt-4 p-3 rounded-md text-sm min-h-[50px]"></div>
                    </div>
                </div>

            </div>

            <!-- Panel Derecho: Vista del Servidor -->
            <div class="bg-gray-900 rounded-xl shadow-2xl p-6 flex flex-col sticky top-8 h-max">
                <h2 class="text-2xl font-bold text-gray-200">üñ•Ô∏è Vista del "Servidor"</h2>
                
                <!-- Consulta SQL en tiempo real -->
                <div class="mt-4">
                    <h3 class="font-semibold text-gray-300 mb-2">Server: SQL Query Log en tiempo real</h3>
                    <div class="bg-black rounded-lg p-4 font-fira text-sm overflow-x-auto border border-gray-700" id="query-container">
                        <pre id="sql-query-display" class="text-gray-300 m-0 whitespace-pre-wrap leading-relaxed">// Esperando una interacci√≥n...</pre>
                    </div>
                    
                    <!-- Indicador de vulnerabilidad -->
                    <div class="mt-2 flex items-center justify-between">
                        <span id="vulnerability-status" class="vulnerability-indicator vuln-safe">SEGURA</span>
                        <span id="injection-type" class="text-xs text-gray-400"></span>
                    </div>
                   <!-- Consulta desglosada en tiempo real -->
                   <div class="mt-4">
                       <h3 class="font-semibold text-gray-300 mb-2">Visor HTML</h3>
                       <div class="bg-gray-800 rounded-lg p-4 font-fira text-sm overflow-x-auto border border-gray-700" id="query-step-container">
                           <pre id="sql-query-step" class="text-gray-300 m-0 whitespace-pre-wrap leading-relaxed">// Esperando una interacci√≥n...</pre>
                       </div>
                   </div>
                </div>

                <!-- An√°lisis detallado -->
                <div id="analysis-box" class="mt-4">
                     <h3 class="font-semibold text-gray-300 mb-2">üî¨ An√°lisis del Payload</h3>
                     <div id="analysis-content" class="p-3 bg-gray-800 rounded-lg text-sm text-gray-300 min-h-[80px] overflow-y-auto analysis-responsive" style="max-height: none;">
                        üí° Escribe en un campo para ver el an√°lisis en tiempo real.
                     </div>
                </div>

                <!-- Estructura de la consulta -->
                <div id="query-breakdown" class="mt-4">
                    <h3 class="font-semibold text-gray-300 mb-2">üß© Estructura de la Consulta</h3>
                    <div id="breakdown-content" class="p-3 bg-gray-800 rounded-lg text-sm text-gray-300 min-h-[60px]">
                        // La estructura aparecer√° aqu√≠
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√≥n para mostrar el men√∫ de debug -->
        <div class="mt-12 text-center">
            <button 
                id="toggle-debug-btn" 
                class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
                onclick="toggleDebugMenu()"
            >
                üîß Mostrar Panel de Debug
            </button>
        </div>

        <!-- Men√∫ de Monitoreo de Base de Datos (inicialmente oculto) -->
        <div id="db-monitoring-menu" class="mt-6 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-xl hidden">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-6">üî¨ Monitor de Base de Datos</h2>
            
            <!-- Opciones de Debug -->
            <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border-l-4 border-yellow-500">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 mb-3">‚öôÔ∏è Opciones de Debug</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button 
                        id="unlock-all-btn" 
                        class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
                        onclick="unlockAllChallenges()"
                    >
                        üîì Desbloquear Todos los Desaf√≠os
                    </button>
                    <button 
                        id="show-solutions-btn" 
                        class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
                        onclick="showSolutionsMenu()"
                    >
                        üìã Ver Soluciones (¬°Spoiler!)
                    </button>
                </div>
            </div>

            <!-- Panel de Soluciones (oculto inicialmente) -->
            <div id="solutions-panel" class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg border-l-4 border-red-500 hidden">
                <h3 class="text-lg font-bold text-red-800 dark:text-red-200 mb-3">‚ö†Ô∏è Soluciones de los Desaf√≠os</h3>
                <div class="space-y-4">
                    <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                        <h4 class="font-bold text-blue-600 dark:text-blue-400">Nivel 1: El Login Roto</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Inyecci√≥n booleana cl√°sica o comentario simple:</p>
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded font-mono text-sm">
                            <div>Usuario: <code class="text-red-600">admin' --</code></div>
                            <div>O Usuario: <code class="text-red-600">admin' OR '1'='1' --</code></div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                        <h4 class="font-bold text-yellow-600 dark:text-yellow-400">Nivel 2: El Buscador Curioso</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Ataque UNION para extraer datos de usuarios:</p>
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded font-mono text-sm">
                            <code class="text-red-600">' UNION SELECT username, password FROM users --</code>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                        <h4 class="font-bold text-red-600 dark:text-red-400">Nivel 3: El Cup√≥n Paciente</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Inyecci√≥n basada en tiempo:</p>
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded font-mono text-sm">
                            <code class="text-red-600">' AND SLEEP(3) --</code>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                        <h4 class="font-bold text-purple-600 dark:text-purple-400">Nivel 4: ¬°Provoca un Error!</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Inyecci√≥n basada en errores:</p>
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded font-mono text-sm">
                            <code class="text-red-600">' AND (SELECT COUNT(*) FROM information_schema.tables) --</code>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                        <h4 class="font-bold text-pink-600 dark:text-pink-400">Nivel 5: Manipula el Orden</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Inyecci√≥n en ORDER BY (varias opciones):</p>
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded font-mono text-sm">
                            <div><code class="text-red-600">(SELECT CASE WHEN 1=1 THEN name ELSE description END)</code></div>
                            <div class="mt-1"><code class="text-red-600">name; DROP TABLE users --</code></div>
                            <div class="mt-1"><code class="text-red-600">(SELECT count(*) FROM users)</code></div>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 p-3 rounded border">
                        <h4 class="font-bold text-indigo-600 dark:text-indigo-400">Nivel 6: Subconsulta Maliciosa</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Inyecci√≥n en subconsulta:</p>
                        <div class="bg-gray-100 dark:bg-gray-700 p-2 rounded font-mono text-sm space-y-1">
                            <div><code class="text-red-600">x' OR 1=1 --</code></div>
                            <div class="text-xs text-gray-500">Hace que toda la condici√≥n sea verdadera</div>
                            <div><code class="text-red-600">x' OR username='admin' --</code></div>
                            <div class="text-xs text-gray-500">Si se conoce que 'admin' es el administrador</div>
                            <div><code class="text-red-600">admin' OR '1'='1</code></div>
                            <div class="text-xs text-gray-500">Usando el nombre admin y a√±adiendo condici√≥n siempre verdadera</div>
                        </div>
                    </div>
                </div>
                <button 
                    id="hide-solutions-btn" 
                    class="mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-colors"
                    onclick="hideSolutionsMenu()"
                >
                    Ocultar Soluciones
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="challenge-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Seleccionar Base de Datos del Desaf√≠o:</label>
                    <select id="challenge-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-gray-50 dark:bg-gray-700">
                        <option value="">-- Selecciona un desaf√≠o --</option>
                        <option value="1">Desaf√≠o 1: Login Roto</option>
                        <option value="2">Desaf√≠o 2, 4, 5: Buscador/Productos</option>
                        <option value="3">Desaf√≠o 3: Cup√≥n Paciente</option>
                        <option value="6">Desaf√≠o 6: Subconsulta Maliciosa</option>
                    </select>
                    <button id="reset-db-button" class="mt-3 w-full bg-red-600 text-white font-bold py-2 px-4 rounded-md hover:bg-red-700 disabled:opacity-50" disabled>
                        Resetear Base de Datos Seleccionada
                    </button>
                </div>
                <div id="db-info-container" class="p-4 bg-gray-100 dark:bg-gray-900 rounded-lg min-h-[200px] overflow-auto">
                    <p class="text-gray-500 dark:text-gray-400 text-center">Selecciona una base de datos para ver su estructura y datos.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
    // --- ESTADO DEL JUEGO Y CONFIGURACI√ìN ---
    const state = {
        unlockedLevels: [1],
        completedLevels: [],
        dbInstances: {} // Almacenar√° las instancias de BBDD para cada desaf√≠o
    };

    let SQL; // Variable global para sql.js

    async function initializeSqlJs() {
        try {
            SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
            });
            console.log("sql.js inicializado correctamente.");
            await setupAllChallengeDatabases(); // Crear todas las BBDD de los desaf√≠os
        } catch (err) {
            console.error("Error inicializando sql.js o configurando bases de datos:", err);
            // Mostrar un mensaje de error al usuario podr√≠a ser una buena idea aqu√≠.
        }
    }

    async function setupAllChallengeDatabases() {
        if (!SQL) {
            console.error("SQL no est√° inicializado. No se pueden crear las bases de datos.");
            return;
        }
        console.log("Creando bases de datos para los desaf√≠os...");
        try {
            // Desaf√≠o 1: Login Roto
            state.dbInstances[1] = new SQL.Database();
            state.dbInstances[1].run("CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, password TEXT);");
            state.dbInstances[1].run("INSERT INTO users (username, password) VALUES ('admin', 'ultra-secret-password-123');");
            state.dbInstances[1].run("INSERT INTO users (username, password) VALUES ('juan', 'password123');");
            state.dbInstances[1].run("INSERT INTO users (username, password) VALUES ('ana', 'qwerty');");

            // Desaf√≠o 2: Buscador Curioso (y 4, 5)
            state.dbInstances[2] = new SQL.Database(); // Usaremos la misma para el 4 y 5 para simplificar
            state.dbInstances[2].run("CREATE TABLE products (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, description TEXT, price REAL);");
            state.dbInstances[2].run("INSERT INTO products (name, description, price) VALUES ('Laptop Pro', 'Potente laptop para profesionales.', 1200.50);");
            state.dbInstances[2].run("INSERT INTO products (name, description, price) VALUES ('Teclado Mec√°nico RGB', 'Teclado con switches cherry-mx.', 75.00);");
            state.dbInstances[2].run("INSERT INTO products (name, description, price) VALUES ('Monitor Ultrawide', 'Monitor de 34 pulgadas curvo.', 450.99);");
            // A√±adir la tabla users tambi√©n para el ataque UNION
            state.dbInstances[2].run("CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, password TEXT, email TEXT);");
            state.dbInstances[2].run("INSERT INTO users (username, password, email) VALUES ('admin', 'adminPass123!', 'admin@example.com');");
            state.dbInstances[2].run("INSERT INTO users (username, password, email) VALUES ('user1', 'securePass!', 'user1@example.com');");
            state.dbInstances[2].run("INSERT INTO users (username, password, email) VALUES ('user2', 'password123', 'user2@example.com');");
            // Asignar la misma instancia a los desaf√≠os 4 y 5
            state.dbInstances[4] = state.dbInstances[2];
            state.dbInstances[5] = state.dbInstances[2];


            // Desaf√≠o 3: Cup√≥n Paciente
            state.dbInstances[3] = new SQL.Database();
            state.dbInstances[3].run("CREATE TABLE coupons (id INTEGER PRIMARY KEY AUTOINCREMENT, code TEXT, discount REAL, expiry_date TEXT);");
            state.dbInstances[3].run("INSERT INTO coupons (code, discount, expiry_date) VALUES ('SUMMER20', 0.20, '2024-08-31');");
            state.dbInstances[3].run("INSERT INTO coupons (code, discount, expiry_date) VALUES ('SAVE10NOW', 0.10, '2024-12-31');");
            // A√±adir una funci√≥n SLEEP simulada (no es SQL est√°ndar pero podemos interceptarla)
            // No es necesario crearla en SQL, la l√≥gica de SLEEP se manejar√° en JavaScript.

            // Desaf√≠o 6: Subconsulta Maliciosa
            state.dbInstances[6] = new SQL.Database();
            state.dbInstances[6].run("CREATE TABLE items (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, owner_id INTEGER);");
            state.dbInstances[6].run("INSERT INTO items (name, owner_id) VALUES ('Documento Secreto', 1);");
            state.dbInstances[6].run("INSERT INTO items (name, owner_id) VALUES ('Llave Maestra', 1);");
            state.dbInstances[6].run("INSERT INTO items (name, owner_id) VALUES ('Notas P√∫blicas', 2);");
            // Crear tabla users para el desaf√≠o
            state.dbInstances[6].run("CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, role TEXT);");
            state.dbInstances[6].run("INSERT INTO users (username, role) VALUES ('admin', 'administrator');");
            state.dbInstances[6].run("INSERT INTO users (username, role) VALUES ('guest', 'visitor');");


            console.log("Bases de datos de los desaf√≠os creadas y pobladas.");
        } catch (err) {
            console.error("Error creando las bases de datos de los desaf√≠os:", err);
        }
    }


    const challenges = {
        1: {
            form: document.getElementById('form-1'),
            inputs: [document.getElementById('input-1-user'), document.getElementById('input-1-pass')],
            resultEl: document.getElementById('result-1'),
            buildQuery: (vals) => `SELECT * FROM users WHERE username = '${vals[0]}' AND password = '${vals[1]}';`,
            checkSuccess: (values, query, dbResult) => {
                const injectionPattern = /(('|\")?\s*or\s*('1'='1|1=1|true)(--)?|'[\s]*--)/i;
                const isInjectionAttempt = injectionPattern.test(values[0]) || injectionPattern.test(values[1]);
                const usernameInput = values[0];
                const passwordInput = values[1];

                if (dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    const loggedInUserRow = dbResult.data[0].values.find(row => row[1] === 'admin'); // Suponiendo que la columna 1 es username

                    if (loggedInUserRow) { // Se encontr√≥ al usuario admin en los resultados
                        if (isInjectionAttempt) {
                            return { status: 'INJECTION_SUCCESS', message: '¬°Inyecci√≥n exitosa! Acceso como admin concedido.' };
                        } else if (usernameInput === 'admin' && passwordInput === loggedInUserRow[2]) { // Suponiendo que la columna 2 es password
                            return { status: 'VALID_LOGIN', message: 'Login con credenciales v√°lidas como admin. ¬°Intenta con inyecci√≥n para avanzar!' };
                        }
                    }
                    // Si no es admin, pero es otro usuario v√°lido (ej. 'juan')
                    const otherUserRow = dbResult.data[0].values.find(row => row[1] === usernameInput && row[2] === passwordInput);
                    if (otherUserRow && !isInjectionAttempt) {
                         return { status: 'VALID_LOGIN_OTHER_USER', message: `Login exitoso como ${usernameInput}. Para este desaf√≠o, necesitas acceder como 'admin' usando una inyecci√≥n.` };
                    }
                }

                if (dbResult && !dbResult.success && dbResult.error) {
                    return { status: 'DB_ERROR', message: `Error DB: ${dbResult.error}` };
                }
                return { status: 'FAILED', message: 'Acceso denegado. Usuario o contrase√±a incorrectos, o la inyecci√≥n no tuvo el efecto esperado.' };
            },
            displayResult: function(checkSuccessResult, dbResult, values) { // Ahora recibe el objeto de checkSuccessResult
                this.resultEl.innerHTML = checkSuccessResult.message;
                if (checkSuccessResult.status === 'INJECTION_SUCCESS') {
                    this.resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200';
                } else if (checkSuccessResult.status === 'VALID_LOGIN' || checkSuccessResult.status === 'VALID_LOGIN_OTHER_USER') {
                    this.resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200';
                } else { // FAILED o DB_ERROR
                    this.resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200';
                }
            },
            analyze: (vals, query) => {
                const injectionPattern = /'\s*or\s*('[^']*'='\d+'|\d+=\d+|true)/i;
                const commentPattern = /'[\s]*--/i;
                const userInjection = vals[0].match(injectionPattern) || vals[0].match(commentPattern);
                const passInjection = vals[1].match(injectionPattern) || vals[1].match(commentPattern);
                const injection = userInjection || passInjection;
                const comment = vals[0].includes('--') || vals[1].includes('--');
                
                if (injection) {
                    const fieldName = userInjection ? 'usuario' : 'contrase√±a';
                    
                    // Detectar si es comentario simple o OR injection
                    if (commentPattern.test(vals[0]) || commentPattern.test(vals[1])) {
                        let analysis = `<div class="space-y-2">
                            <div class="text-red-400 font-bold">üîç INYECCI√ìN DE COMENTARIO DETECTADA</div>
                            <div class="text-sm">La inyecci√≥n <span class="sql-red font-mono">' --</span> en el campo ${fieldName} cierra la cadena y comenta el resto:</div>
                            <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                                <div class="text-blue-400">Consulta original:</div>
                                <div class="text-gray-300">WHERE username = '${vals[0]}' AND password = '${vals[1]}'</div>
                                <div class="text-red-300 mt-1">Resultado:</div>
                                <div class="text-gray-300">WHERE username = '${vals[0].split("'")[0]}' <span class="sql-gray">-- AND password = '${vals[1]}'</span></div>
                            </div>
                            <div class="text-sm">Es posible cerrar la cadena con <code class="sql-blue font-mono">'</code> y comentar el resto con <code class="sql-gray font-mono">--</code>, ignorando la validaci√≥n de contrase√±a.</div>
                        </div>`;
                        return analysis;
                    } else {
                        let analysis = `<div class="space-y-2">
                            <div class="text-red-400 font-bold">üîç INYECCI√ìN BOOLEANA DETECTADA</div>
                            <div class="text-sm">La inyecci√≥n <span class="sql-red font-mono">' OR 1=1'</span> en el campo ${fieldName} rompe la l√≥gica de autenticaci√≥n:</div>
                            <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                                <div>Consulta original: WHERE username = '${vals[0]}' AND password = '${vals[1]}'</div>
                                <div class="text-red-300">Resultado: La condici√≥n WHERE se vuelve TRUE porque '1=1' siempre es verdadero</div>
                            </div>
                            <div class="text-sm">Como <code class="sql-blue font-mono">'1=1'</code> siempre es <span class="text-green-400">TRUE</span>, toda la condici√≥n WHERE es verdadera.</div>`;
                        
                        if (comment) {
                            analysis += `<div class="text-sm">El comentario <span class="sql-gray font-mono">--</span> ignora el resto de la consulta, evitando errores de sintaxis.</div>`;
                        }
                        
                        analysis += `</div>`;
                        return analysis;
                    }
                }
                
                if (vals[0].includes("'") || vals[1].includes("'")) {
                    return '<div class="text-yellow-400">Se detectan comillas en la entrada. Esto podr√≠a ser el inicio de una inyecci√≥n SQL. Es posible agregar una condici√≥n que siempre sea verdadera o usar comentarios para saltarse la validaci√≥n.</div>';
                }
                
                return '<div class="text-gray-400">No se detect√≥ una inyecci√≥n. El objetivo es hacer que la condici√≥n WHERE siempre sea verdadera usando <code class="sql-blue font-mono">\' OR \'1\'=\'1</code> o simplemente comentar con <code class="sql-gray font-mono">\' --</code>.</div>';
            }
        },
        2: {
            form: document.getElementById('form-2'),
            inputs: [document.getElementById('input-2-search')],
            resultEl: document.getElementById('result-2'),
            buildQuery: (vals) => `SELECT name, description FROM products WHERE name LIKE '%${vals[0]}%';`,
            checkSuccess: (values, query, dbResult) => {
                const isUnionFromUsersAttempt = /union\s+select\s+[^,]+,\s*[^,]+\s+from\s+users/i.test(query);

                if (isUnionFromUsersAttempt && dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    // Si la consulta UNION SELECT ... FROM users fue exitosa y devolvi√≥ datos, es un √©xito.
                    // El n√∫mero de columnas debe coincidir para que SQLite no de error, lo cual est√° impl√≠cito en dbResult.success.
                    // Adicionalmente, nos aseguramos que la parte original de la query no produzca estos mismos resultados.
                    const originalQueryPart = query.split(/UNION/i)[0];
                    let originalResultsCount = 0;
                    try {
                        const originalExecResult = state.dbInstances[2].exec(originalQueryPart);
                        if (originalExecResult.length > 0 && originalExecResult[0].values) {
                            originalResultsCount = originalExecResult[0].values.length;
                        }
                    } catch(e) {/*ignorar error si la primera parte falla por la inyeccion*/}

                    // Si la query original no devolvi√≥ nada, o devolvi√≥ menos filas que la query completa con UNION,
                    // y la query completa devolvi√≥ filas, es probable que la inyecci√≥n sea la fuente de los datos.
                    if (dbResult.data[0].values.length > originalResultsCount) {
                        return true;
                    }
                    // Caso especial: si la query original devuelve algo, pero la inyecci√≥n a√±ade m√°s filas de users.
                    // O si la query original da error (originalResultsCount = 0) y la inyecci√≥n funciona.
                    if (originalResultsCount === 0 && dbResult.data[0].values.length > 0){
                        return true;
                    }
                }
                return false;
            },
            displayResult: function(isSuccess, dbResult, values) {
                this.resultEl.innerHTML = ''; // Limpiar resultados anteriores
                if (isSuccess && dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    this.resultEl.innerHTML = `<div class="p-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 text-sm"><strong>¬°PELIGRO!</strong> Se han extra√≠do datos sensibles.</div>`;
                    const headers = dbResult.data[0].columns;
                    const dataRows = dbResult.data[0].values;

                    dataRows.forEach(row => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow mt-2';
                        let rowHtml = '';
                        row.forEach((cell, index) => {
                            rowHtml += `<p class="text-sm"><strong class="text-red-400">${headers[index]}:</strong> <span class="font-fira">${cell}</span></p>`;
                        });
                        itemEl.innerHTML = rowHtml;
                        this.resultEl.appendChild(itemEl);
                    });
                } else if (dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    // Resultados normales de la b√∫squeda de productos
                    const headers = dbResult.data[0].columns;
                    const dataRows = dbResult.data[0].values;
                    dataRows.forEach(row => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow mt-2';
                        itemEl.innerHTML = `<h4 class="font-bold">${row[headers.indexOf('name')]}</h4><p class="text-sm text-gray-600 dark:text-gray-400">${row[headers.indexOf('description')]}</p>`;
                        this.resultEl.appendChild(itemEl);
                    });
                } else if (dbResult && dbResult.error) {
                     this.resultEl.innerHTML = `<div class="p-3 text-center text-red-500">Error en la consulta: ${dbResult.error}</div>`;
                } else {
                     this.resultEl.innerHTML = `<div class="p-3 text-center text-gray-500">No se encontraron resultados.</div>`;
                }
            },
            analyze: (vals, query) => {
                const injection = query.match(/union\s+select\s+([\w\*\s,]+)\s+from\s+([\w]+)/i);
                if (injection && injection[2].toLowerCase() === 'users') {
                    return `<div class="space-y-2">
                        <div class="text-red-400 font-bold">üîç ATAQUE UNION DETECTADO</div>
                        <div class="text-sm">El ataque <span class="sql-red font-mono">UNION SELECT</span> permite combinar resultados de dos consultas:</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Consulta original: SELECT name, description FROM products WHERE name LIKE '%[input]%'</div>
                            <div class="text-red-300">Consulta inyectada: SELECT name, description FROM products WHERE name LIKE '%' UNION SELECT username, password FROM users%'</div>
                        </div>
                        <div class="text-sm">Esto expone datos sensibles de la tabla <span class="sql-table font-mono">users</span>, mostrando nombres de usuario y contrase√±as.</div>
                        <div class="text-sm text-yellow-300">‚ö†Ô∏è En un ataque real, esto comprometer√≠a toda la base de datos de usuarios.</div>
                    </div>`;
                }
                
                if (vals[0].toLowerCase().includes("union")) {
                    return '<div class="text-yellow-400">Se detect√≥ la palabra clave UNION. Es necesario asegurar que el n√∫mero de columnas coincida con la consulta original (2 columnas en este caso).</div>';
                }
                
                if (vals[0].includes("'")) {
                    return '<div class="text-yellow-400">Se detectan comillas. Para un ataque UNION, es necesario cerrar la cadena y luego a√±adir la consulta SELECT.</div>';
                }
                
                return '<div class="text-gray-400">No se detect√≥ un ataque UNION. El objetivo es a√±adir una segunda consulta SELECT para extraer datos de la tabla <code class="sql-blue font-mono">users</code>.</div>';
            }
        },
        3: {
            form: document.getElementById('form-3'),
            inputs: [document.getElementById('input-3-coupon')],
            resultEl: document.getElementById('result-3'),
            buildQuery: (vals) => `SELECT discount FROM coupons WHERE code = '${vals[0]}';`,
            checkSuccess: (values, query, dbResult) => {
                // El √©xito se maneja principalmente en handleSubmit para este desaf√≠o debido al delay.
                // Aqu√≠ solo verificamos que la query contenga SLEEP(N) con N > 0.
                // dbResult.success ser√° true si la simulaci√≥n de SLEEP en handleSubmit fue "exitosa".
                const match = query.match(/sleep\((\d+)\)/i);
                return match && parseInt(match[1], 10) > 0 && dbResult && dbResult.success;
            },
            displayResult: function(isSuccess, dbResult, values) {
                // El mensaje de "Validando cup√≥n..." y el delay se manejan en handleSubmit
                const couponCode = values[0];
                if (isSuccess) {
                     const delay = couponCode.match(/sleep\((\d+)\)/i)[1];
                    this.resultEl.innerHTML = `‚úÖ ¬°√âxito! El servidor tard√≥ ${delay} segundos en responder. Has confirmado una inyecci√≥n a ciegas.`;
                    this.resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200';
                } else {
                    let errorMsg = `‚ùå El cup√≥n no es v√°lido`;
                     if (dbResult && dbResult.error) {
                        errorMsg += `<br><small class="text-red-400">Error DB: ${dbResult.error}</small>`;
                    } else {
                        errorMsg += ` y el servidor respondi√≥ instant√°neamente. No se detect√≥ retraso.`;
                    }
                    this.resultEl.innerHTML = errorMsg;
                    this.resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200';
                }
            },
            analyze: (vals, query) => {
                const injection = query.match(/sleep\((\d+)\)/i);
                if (injection) {
                    const seconds = injection[1];
                    return `<div class="space-y-2">
                        <div class="text-red-400 font-bold">üîç INYECCI√ìN BASADA EN TIEMPO DETECTADA</div>
                        <div class="text-sm">La funci√≥n <span class="sql-red font-mono">SLEEP(${seconds})</span> ordena a la base de datos esperar ${seconds} segundos:</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Consulta original: SELECT discount FROM coupons WHERE code = '[input]'</div>
                            <div class="text-red-300">Consulta inyectada: SELECT discount FROM coupons WHERE code = '' AND SLEEP(${seconds})--'</div>
                        </div>
                        <div class="text-sm">Si la p√°gina tarda ${seconds} segundos extra en cargar, has confirmado la vulnerabilidad.</div>
                        <div class="text-sm text-yellow-300">‚ö†Ô∏è Este tipo de ataque es √∫til cuando no puedes ver errores o datos directamente.</div>
                    </div>`;
                }
                return '<div class="text-gray-400">No se detect√≥ una inyecci√≥n basada en tiempo. El objetivo es inyectar una funci√≥n que pause la ejecuci√≥n de la base de datos, como <code class="sql-blue font-mono">SLEEP(seconds)</code>.</div>';
            }
        },
        4: {
            form: document.getElementById('form-4'),
            inputs: [document.getElementById('input-4-search')],
            resultEl: document.getElementById('result-4'),
            buildQuery: (vals) => `SELECT name, description FROM products WHERE name LIKE '%${vals[0]}%';`,
            checkSuccess: (values, query, dbResult) => {
                // √âxito si la query contiene una t√©cnica de error-based conocida Y la DB devuelve un error.
                const isErrorBasedAttempt = /extractvalue|updatexml|floor\(rand\(0\)\*2\)|geometrycollection|polygon|multipoint|linestring|exp\(|information_schema/i.test(query);
                return isErrorBasedAttempt && dbResult && !dbResult.success && dbResult.error;
            },
            displayResult: function(isSuccess, dbResult, values) {
                this.resultEl.innerHTML = '';
                const searchTerm = values[0];
                if (isSuccess && dbResult && dbResult.error) {
                    this.resultEl.innerHTML = `<div class="p-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 text-sm">
                        <strong>Error SQL:</strong> <pre class="whitespace-pre-wrap font-fira">${dbResult.error}</pre>
                    </div>
                    <div class="mt-2 p-3 bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 text-sm">
                        ‚úÖ <strong>¬°√âxito!</strong> Has provocado un error en la base de datos que podr√≠a revelar informaci√≥n.
                        En SQLite, los errores son menos verbosos, pero la t√©cnica es v√°lida.
                    </div>`;
                } else if (dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    const headers = dbResult.data[0].columns;
                    const dataRows = dbResult.data[0].values;
                    dataRows.forEach(row => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow mt-2';
                        itemEl.innerHTML = `<h4 class="font-bold">${row[headers.indexOf('name')]}</h4><p class="text-sm text-gray-600 dark:text-gray-400">${row[headers.indexOf('description')]}</p>`;
                        this.resultEl.appendChild(itemEl);
                    });
                } else if (dbResult && !dbResult.success && dbResult.error) {
                     this.resultEl.innerHTML = `<div class="p-3 text-center text-red-500">Error en la consulta no esperado: ${dbResult.error}</div>`;
                } else {
                    this.resultEl.innerHTML = `<div class="p-3 text-center text-gray-500">No se encontraron productos o la consulta no produjo el error esperado.</div>`;
                }
            },
            analyze: (vals, query) => {
                 if (/extractvalue|updatexml|floor\(rand\(0\)\*2\)|information_schema.*count\(\*\)/i.test(query)) {
                    return `<div class="space-y-2">
                        <div class="text-purple-400 font-bold">üîç INYECCI√ìN BASADA EN ERRORES DETECTADA</div>
                        <div class="text-sm">Has usado <span class="sql-red font-mono">information_schema</span> junto con funciones que pueden provocar errores controlados.</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Payload: ${vals[0]}</div>
                        </div>
                        <div class="text-sm text-yellow-300">‚ö†Ô∏è Los errores de MySQL pueden revelar nombres de bases de datos, tablas y otra informaci√≥n sensible.</div>
                    </div>`;
                }
                if (/information_schema/i.test(vals[0])) {
                    return '<div class="text-yellow-400">Detectado <code class="sql-blue font-mono">information_schema</code>. Es necesario a√±adir funciones que provoquen errores como <code class="sql-blue font-mono">FLOOR(RAND()*2)</code> y <code class="sql-blue font-mono">COUNT(*)</code>.</div>';
                }
                return '<div class="text-gray-400">El objetivo es provocar un error de MySQL que revele informaci√≥n. Es posible usar <code class="sql-blue font-mono">information_schema</code> con subconsultas que generen duplicados.</div>';
            }
        },
        5: {
            form: document.getElementById('form-5'),
            inputs: [document.getElementById('input-5-order')],
            resultEl: document.getElementById('result-5'),
            buildQuery: (vals) => `SELECT name, description FROM products ORDER BY ${vals[0]};`,
            checkSuccess: (values, query, dbResult) => {
                const userInput = values[0].toLowerCase();
                const isUnionSelectAttempt = /union\s+select/i.test(userInput);
                const isCaseExpressionAttempt = /case\s+when/i.test(userInput);
                const causesError = dbResult && !dbResult.success && dbResult.error;

                // Escenario 1: La inyecci√≥n causa un error (y no es un simple error de columna no existente si no es complejo)
                if (causesError) {
                    if (isUnionSelectAttempt || isCaseExpressionAttempt || userInput.includes(";") || userInput.includes("--")) {
                        return { success: true, type: "ERROR_BASED" };
                    }
                    // Si no es una inyecci√≥n compleja reconocida pero aun as√≠ causa error (ej. 'columna_inexistente'), no es el objetivo principal.
                    // Pero si el usuario intenta algo como 'name; DROP TABLE users', el error es el √©xito.
                    if (userInput.includes(";") || userInput.includes("--")) return { success: true, type: "ERROR_BASED" };

                    // Considerar un error por subconsulta inv√°lida como √©xito tambi√©n
                    if (userInput.includes("select") && causesError) return { success: true, type: "ERROR_BASED" };

                    return { success: false, type: "GENERIC_ERROR_NOT_ADVANCING" }; // Error gen√©rico, no avanza.
                }

                // Escenario 2: Se usa UNION SELECT y la query se ejecuta sin error (SQLite lo acept√≥ sint√°cticamente)
                if (isUnionSelectAttempt && dbResult && dbResult.success) {
                     // Y que devuelva datos (aunque sean los originales, la manipulaci√≥n sint√°ctica es el punto aqu√≠)
                    if (dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                        return { success: true, type: "UNION_ACCEPTED" };
                    }
                }

                // Escenario 3: Se usa una expresi√≥n CASE y la query se ejecuta (el cambio de orden ser√≠a la prueba)
                // Esto es dif√≠cil de verificar autom√°ticamente sin conocer los datos esperados.
                // Por ahora, si incluye CASE y no da error, lo tomamos como un intento v√°lido.
                if (isCaseExpressionAttempt && dbResult && dbResult.success) {
                     return { success: true, type: "CASE_ACCEPTED" };
                }

                return { success: false, type: "NO_EFFECT" };
            },
            displayResult: function(outcome, dbResult, values) { // outcome es el objeto de checkSuccess
                this.resultEl.innerHTML = '';
                if (outcome.success) {
                    if (outcome.type === "ERROR_BASED" && dbResult && dbResult.error) {
                        this.resultEl.innerHTML = `<div class="p-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 text-sm">
                            <strong>Error SQL Provocado:</strong> <pre class="whitespace-pre-wrap font-fira">${dbResult.error}</pre>
                        </div>
                        <div class="mt-2 p-3 bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-200 text-sm">
                            ‚úÖ <strong>¬°√âxito!</strong> Has manipulado el ORDER BY y provocado un error con tu inyecci√≥n.
                        </div>`;
                    } else if (outcome.type === "UNION_ACCEPTED") {
                         this.resultEl.innerHTML = `<div class="p-3 rounded-md bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 text-sm">
                            ‚úÖ <strong>¬°√âxito!</strong> SQLite acept√≥ tu <code class="font-fira">UNION SELECT</code> en la cl√°usula ORDER BY. Aunque la extracci√≥n de datos directa es compleja aqu√≠, has alterado la consulta.
                        </div>`;
                    } else if (outcome.type === "CASE_ACCEPTED") {
                        this.resultEl.innerHTML = `<div class="p-3 rounded-md bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 text-sm">
                           ‚úÖ <strong>¬°√âxito!</strong> SQLite acept√≥ tu expresi√≥n <code class="font-fira">CASE</code> en la cl√°usula ORDER BY. Podr√≠as usar esto para inferir datos booleanos alterando el orden de los resultados.
                       </div>`;
                   }
                     this.resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200';
                } else if (dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    // No hubo √©xito en la inyecci√≥n, pero se muestran datos ordenados normalmente.
                    const headers = dbResult.data[0].columns;
                    const dataRows = dbResult.data[0].values;
                    dataRows.forEach(row => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg shadow mt-2';
                        itemEl.innerHTML = `<h4 class="font-bold">${row[headers.indexOf('name')]}</h4><p class="text-sm text-gray-600 dark:text-gray-400">${row[headers.indexOf('description')]}</p>`;
                        this.resultEl.appendChild(itemEl);
                    });
                } else if (dbResult && !dbResult.success && dbResult.error) {
                     this.resultEl.innerHTML = `<div class="p-3 text-center text-red-500">Error en la consulta no esperado: ${dbResult.error}</div>`;
                } else {
                    this.resultEl.innerHTML = `<div class="p-3 text-center text-gray-500">La consulta se ejecut√≥, pero no se detect√≥ la inyecci√≥n o error esperado.</div>`;
                }
            },
            analyze: (vals, query) => {
                const userInput = vals[0];
                // Regex mejorada para detectar varios patrones de inyecci√≥n en ORDER BY
                if (/(union\s+select|case\s+when|select\s*\(|(?:^|,|\s)\(select\s|;\s*\w|--)/i.test(userInput)) {
                    return `<div class="space-y-2">
                        <div class="text-pink-400 font-bold">üîç INYECCI√ìN EN ORDER BY DETECTADA</div>
                        <div class="text-sm">Has intentado una inyecci√≥n compleja en la cl√°usula ORDER BY.</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>ORDER BY ${userInput}</div>
                        </div>
                        <div class="text-sm text-yellow-300">‚ö†Ô∏è En SQLite, inyectar directamente <code class="font-fira">SELECT</code> o <code class="font-fira">UNION</code> en ORDER BY a menudo causa errores o tiene un comportamiento no est√°ndar. Las expresiones <code class="font-fira">CASE</code> o provocar errores controlados son t√©cnicas m√°s comunes para inferir datos. <code class="font-fira">information_schema</code> no est√° disponible en SQLite.</div>
                    </div>`;
                }
                if (/information_schema/i.test(userInput)) { // Espec√≠ficamente para information_schema
                    return `<div class="text-yellow-400">Detectado <code class="font-fira bg-yellow-200 dark:bg-yellow-800 px-1 rounded">information_schema</code>. Recordar que SQLite no usa <code class="font-fira bg-yellow-200 dark:bg-yellow-800 px-1 rounded">information_schema</code> como MySQL/PostgreSQL. Es posible intentar con expresiones <code class="font-fira bg-yellow-200 dark:bg-yellow-800 px-1 rounded">CASE</code> o subconsultas que puedan alterar el orden o provocar errores espec√≠ficos de SQLite.</div>`;
                }
                return '<div class="text-gray-400">El par√°metro ORDER BY puede ser vulnerable. Es posible intentar con expresiones <code class="font-fira bg-blue-200 dark:bg-blue-800 px-1 rounded">CASE WHEN...END</code>, subconsultas simples que devuelvan un valor (ej. <code class="font-fira bg-blue-200 dark:bg-blue-800 px-1 rounded">(SELECT count(*) FROM users)</code>), o intentar provocar un error SQL para verificar si el sistema es vulnerable.</div>';
            }
        },
        6: {
            form: document.getElementById('form-6'),
            inputs: [document.getElementById('input-6-check')],
            resultEl: document.getElementById('result-6'),
            buildQuery: (vals) => `SELECT * FROM items WHERE owner_id = (SELECT id FROM users WHERE username = '${vals[0]}' AND role='administrator');`,
            checkSuccess: (values, query, dbResult) => {
                const isAdminInput = values[0].toLowerCase() === 'admin';
                const isInjectionBypass = /or\s+username\s*=\s*'admin'/i.test(values[0]) || /or\s+'1'\s*=\s*'1'/i.test(values[0]) || /or\s+1\s*=\s*1/i.test(values[0]) || /or.*--/i.test(values[0]) || /admin'\s+or/i.test(values[0]);

                if (dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    // Si se obtienen items, es un √©xito.
                    // Si el input no era 'admin' pero se us√≥ una inyecci√≥n para simular ser admin, es el objetivo principal.
                    if (!isAdminInput && isInjectionBypass) {
                        return true;
                    }
                    // Si el input era 'admin' (sin inyecci√≥n) y se obtienen items, tambi√©n es un "√©xito" en t√©rminos de funcionalidad.
                    if (isAdminInput && !isInjectionBypass) {
                        return true;
                    }
                }
                return false;
            },
            displayResult: function(isSuccess, dbResult, values) {
                this.resultEl.innerHTML = '';
                if (isSuccess && dbResult && dbResult.success && dbResult.data.length > 0 && dbResult.data[0].values.length > 0) {
                    let message = `‚úÖ <strong>¬°Acceso concedido!</strong> Se han encontrado los siguientes items:`;
                    const isAdminInput = values[0].toLowerCase() === 'admin';
                    const isInjectionBypass = /or\s+username\s*=\s*'admin'/i.test(values[0]) || /or\s+'1'\s*=\s*'1'/i.test(values[0]) || /or\s+1\s*=\s*1/i.test(values[0]) || /or.*--/i.test(values[0]) || /admin'\s+or/i.test(values[0]);

                    if (!isAdminInput && isInjectionBypass) {
                        message = `‚úÖ <strong>¬°Inyecci√≥n Exitosa!</strong> Has accedido a los items del administrador:`;
                    }
                    this.resultEl.innerHTML = `<div class="p-3 rounded-md bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 text-sm">${message}</div>`;
                    dbResult.data[0].values.forEach(row => {
                        const itemEl = document.createElement('div');
                        itemEl.className = 'p-2 mt-2 bg-gray-50 dark:bg-gray-700/50 rounded text-sm';
                        itemEl.innerHTML = `<strong>Nombre:</strong> ${row[1]} (Due√±o ID: ${row[2]})`; // Asumiendo columnas id, name, owner_id
                        this.resultEl.appendChild(itemEl);
                    });
                } else if (dbResult && !dbResult.success && dbResult.error) {
                    this.resultEl.innerHTML = `<div class="p-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200 text-sm">‚ùå Error en la consulta: ${dbResult.error}</div>`;
                } else {
                    this.resultEl.innerHTML = `<div class="mt-4 p-3 rounded-md text-sm min-h-[50px] bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-200">‚ùå No se pudo acceder a los items o la subconsulta no devolvi√≥ un ID de administrador v√°lido.</div>`;
                }
            },
            analyze: (vals, query) => {
                 if (/(or\s+username\s*=\s*'admin'|or\s+'1'='1'|or\s+1=1|or.*--|admin'\s+or)/i.test(vals[0])) {
                    return `<div class="space-y-2">
                        <div class="text-indigo-400 font-bold">üîç INYECCI√ìN EN SUBCONSULTA DETECTADA</div>
                        <div class="text-sm">Has inyectado una subconsulta que puede saltarse la validaci√≥n del sistema.</div>
                        <div class="bg-gray-700 p-2 rounded text-xs font-mono">
                            <div>Subconsulta: ${vals[0]}</div>
                        </div>
                        <div class="text-sm text-yellow-300">‚ö†Ô∏è Las subconsultas maliciosas pueden forzar condiciones TRUE y obtener acceso no autorizado.</div>
                    </div>`;
                }
                if (/select.*count/i.test(vals[0])) {
                    return '<div class="text-yellow-400">Detectado <code class="sql-blue font-mono">SELECT COUNT</code>. Es posible a√±adir condiciones <code class="sql-blue font-mono">WHERE</code> que siempre sean verdaderas para forzar el resultado.</div>';
                }
                return '<div class="text-gray-400">El objetivo es inyectar una subconsulta que devuelva TRUE. Es posible usar <code class="sql-blue font-mono">SELECT COUNT(*) FROM users WHERE</code> con condiciones siempre verdaderas.</div>';
            }
        }
    };

    // --- L√ìGICA PRINCIPAL ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeSqlJs(); // Esperar a que sql.js se inicialice
        updateUI();
        setupChallengeHandlers();
        setupDbMonitoringMenu(); // Configurar el men√∫ de monitoreo
    });

    function setupChallengeHandlers() {
        Object.keys(challenges).forEach(key => {
            const id = parseInt(key, 10);
            const challenge = challenges[id];
            
            challenge.inputs.forEach(input => {
                input.addEventListener('input', () => handleRealtimeUpdate(id));
            });

            challenge.form.addEventListener('submit', (e) => {
                e.preventDefault();
                console.log(`Submit for challenge ${id}`); // Depuraci√≥n
                handleSubmit(id);
            });
        });
    }

    function executeQuery(dbInstance, query) {
        try {
            const results = dbInstance.exec(query);
            return { success: true, data: results, error: null };
        } catch (e) {
            console.error("Error ejecutando query:", e, "en query:", query);
            return { success: false, data: [], error: e.message };
        }
    }

    function handleRealtimeUpdate(id) {
        if (!state.unlockedLevels.includes(id)) return;
        const challenge = challenges[id];
        const values = challenge.inputs.map(i => i.value);
        const query = challenge.buildQuery(values);
        displayQuery(query); // Muestra la query SQL construida

        const analysis = challenge.analyze(values, query); // Pasa la query para an√°lisis m√°s profundo si es necesario
        document.getElementById('analysis-content').innerHTML = analysis;
        
        adjustAnalysisPanelHeight();
    }

    function adjustAnalysisPanelHeight() {
        const analysisContent = document.getElementById('analysis-content');
        if (analysisContent) {
            analysisContent.style.maxHeight = 'none';
            analysisContent.style.height = 'auto';
            const scrollHeight = analysisContent.scrollHeight;
            if (scrollHeight > 400) {
                analysisContent.style.maxHeight = '400px';
                analysisContent.style.overflowY = 'auto';
            } else {
                analysisContent.style.maxHeight = 'none';
                analysisContent.style.overflowY = 'visible';
                analysisContent.style.height = `${Math.max(scrollHeight, 80)}px`;
            }
        }
    }

    async function handleSubmit(id) {
        if (!state.unlockedLevels.includes(id) || !SQL) return;
        console.log(`Submit for challenge ${id}`);

        const challenge = challenges[id];
        const values = challenge.inputs.map(i => i.value);
        const query = challenge.buildQuery(values); // La query que el usuario intenta inyectar

        let resultFromDB = { success: false, data: [], error: null };
        let isSuccessBasedOnInjection = false; // Para desaf√≠os que no dependen del resultado de la DB directamente (ej. SLEEP)

        if (id === 3) { // Desaf√≠o de Inyecci√≥n Basada en Tiempo
            const match = query.match(/SLEEP\((\d+)\)/i);
            if (match && parseInt(match[1], 10) > 0) {
                const delay = parseInt(match[1], 10) * 1000;
                challenge.resultEl.innerHTML = `Validando cup√≥n... <div class="w-4 h-4 border-2 border-dashed rounded-full animate-spin border-blue-500"></div>`;
                challenge.resultEl.className = 'mt-4 p-3 rounded-md text-sm min-h-[50px] bg-gray-100 dark:bg-gray-700 flex items-center gap-2';

                await new Promise(resolve => setTimeout(resolve, delay));
                isSuccessBasedOnInjection = true;
                // No ejecutamos la query en la DB para SLEEP, solo simulamos el retraso.
                // El `challenge.checkSuccess` para el desaf√≠o 3 debe manejar esto.
                 resultFromDB = { success: true, data: [{columns:['simulated'], values:[['sleep executed']]}] }; // Simular un resultado
            } else {
                // Si no hay SLEEP, ejecutar la query normalmente
                resultFromDB = executeQuery(state.dbInstances[id], query);
            }
        } else if (state.dbInstances[id]) {
            resultFromDB = executeQuery(state.dbInstances[id], query);
        } else {
            console.error(`No database instance found for challenge ${id}`);
            challenge.resultEl.innerHTML = `<div class="text-red-500">Error: No se encontr√≥ la base de datos para este desaf√≠o.</div>`;
            return;
        }

        // `checkSuccess` ahora puede tomar la query original, los valores, Y el resultado de la DB.
        const challengeOutcome = challenge.checkSuccess(values, query, resultFromDB);

        // Actualizar UI con resultados
        // Para el desaf√≠o 1, displayResult ahora toma challengeOutcome directamente.
        // Para otros desaf√≠os, se asume que displayResult todav√≠a espera un booleano isSuccess y dbResult.
        if (id === 1) {
            challenge.displayResult(challengeOutcome, resultFromDB, values);
        } else {
            // Para los otros desaf√≠os, mantenemos la l√≥gica anterior hasta que se refactoricen.
            // challengeOutcome aqu√≠ ser√≠a el booleano de la antigua funci√≥n checkSuccess.
            challenge.displayResult(challengeOutcome, resultFromDB, values);
        }

        // Determinar si se avanza de nivel
        let allowLevelAdvance = false;
        if (id === 1) {
            allowLevelAdvance = challengeOutcome.status === 'INJECTION_SUCCESS';
        } else if (id === 3) { // Desaf√≠o de tiempo
            allowLevelAdvance = isSuccessBasedOnInjection || challengeOutcome; // challengeOutcome es el booleano de checkSuccess (devuelve true/false)
        } else if (id === 5) {
            allowLevelAdvance = challengeOutcome.success; // challengeOutcome es {success: bool, type: string}
        }
         else { // Para otros desaf√≠os (2, 4, 6)
            allowLevelAdvance = challengeOutcome; // challengeOutcome es el booleano de checkSuccess
        }

        if (allowLevelAdvance && !state.completedLevels.includes(id)) {
            state.completedLevels.push(id);
            const nextLevel = id + 1;
            if (challenges[nextLevel] && !state.unlockedLevels.includes(nextLevel)) {
                state.unlockedLevels.push(nextLevel);
                showToast(`¬°Felicidades! Has desbloqueado el Nivel ${nextLevel}.`);
            }
            updateUI();
        }
    }

    // --- MANEJADORES DE RESULTADOS (ahora parte de `challenges[id].displayResult`) ---
    // Las funciones handleLoginSubmit, handleSearchSubmit, etc., ser√°n reemplazadas o integradas
    // en una nueva propiedad `displayResult` dentro de cada objeto `challenge`.

    // --- FUNCIONES DE UI ---
    function updateUI() {
        Object.keys(challenges).forEach(key => {
            const id = parseInt(key, 10);
            const card = document.getElementById(`challenge-${id}`);
            if (state.unlockedLevels.includes(id)) {
                card.classList.remove('locked');
                card.style.pointerEvents = 'auto';
            } else {
                card.classList.add('locked');
                card.style.pointerEvents = 'none';
            }
            if(state.completedLevels.includes(id)) {
                card.classList.add('completed');
                card.classList.remove('border-blue-500', 'border-gray-500');
            }
        });
        
        const progress = (state.completedLevels.length / Object.keys(challenges).length) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        
        const progressTextEl = document.getElementById('progress-text');
        const totalLevels = Object.keys(challenges).length;
        const completedCount = state.completedLevels.length;
        
        if (completedCount === 0) {
            progressTextEl.textContent = `0% completado - ¬°Comienza tu aventura!`;
        } else if (completedCount === totalLevels) {
            progressTextEl.textContent = `üéâ 100% completado - ¬°Eres un experto en SQLi!`;
        } else {
            progressTextEl.textContent = `${Math.round(progress)}% completado - Nivel ${completedCount} de ${totalLevels} completo`;
        }
    }

    function displayQuery(query) {
        let highlightedQuery = query;

        // Separar comentarios primero
        const commentMatch = query.match(/(--.*)$/);
        let commentPart = '';
        let queryPart = query;
        if (commentMatch) {
            commentPart = `<span class="sql-gray">${commentMatch[0]}</span>`;
            queryPart = query.substring(0, query.indexOf(commentMatch[0]));
        }

        // Resaltar inyecciones, cadenas y palabras clave en la parte no comentada
        const regex = /(' OR '1'='1|UNION\s+SELECT|SLEEP\(\d+\)|'\s*--)|('[^']*')|(\bSELECT\b|\bFROM\b|\bWHERE\b|\bAND\b)/gi;
        highlightedQuery = queryPart.replace(regex, (match, injection, string, keyword) => {
            if (injection) return `<span class="sql-red">${injection}</span>`;
            if (string) return `<span class="sql-green">${string}</span>`;
            if (keyword) return `<span class="sql-blue">${keyword}</span>`;
            return match;
        }) + commentPart;

        // Mostrar la consulta resaltada
        document.getElementById('sql-query-display').innerHTML = highlightedQuery || '<span class="text-gray-300">// Esperando una interacci√≥n...</span>';

        // Detectar vulnerabilidad (insensible a may√∫sculas)
        let detectedInjection = null;
        const lowerQuery = query.toLowerCase();
        if (lowerQuery.includes("' or '1'='1") || lowerQuery.includes("' or 1=1")) {
            detectedInjection = { type: 'Inyecci√≥n Booleana Cl√°sica', danger: 'vuln-danger' };
        } else if (lowerQuery.includes("' --") || /'\s*--/.test(lowerQuery)) {
            detectedInjection = { type: 'Inyecci√≥n de Comentario', danger: 'vuln-danger' };
        } else if (lowerQuery.includes("union select")) {
            detectedInjection = { type: 'Ataque UNION SELECT', danger: 'vuln-danger' };
        } else if (lowerQuery.includes("sleep(")) {
            detectedInjection = { type: 'Inyecci√≥n Basada en Tiempo', danger: 'vuln-danger' };
        }

        const statusEl = document.getElementById('vulnerability-status');
        const typeEl = document.getElementById('injection-type');
        if (detectedInjection) {
            statusEl.textContent = 'VULNERABLE';
            statusEl.className = `vulnerability-indicator ${detectedInjection.danger}`;
            typeEl.textContent = detectedInjection.type;
        } else if (query.includes("'") || query.includes('"')) {
            statusEl.textContent = 'SOSPECHOSA';
            statusEl.className = 'vulnerability-indicator vuln-warning';
            typeEl.textContent = 'Entrada con comillas detectada';
        } else {
            statusEl.textContent = 'SEGURA';
            statusEl.className = 'vulnerability-indicator vuln-safe';
            typeEl.textContent = '';
        }

        // Actualizar vista paso a paso
        mostrarHTMLFormulario(query);
        updateQueryBreakdown(query, detectedInjection);
        
        // Ajustar altura del panel de an√°lisis si existe contenido
        setTimeout(adjustAnalysisPanelHeight, 100);
    }

    function mostrarHTMLFormulario(query) {
        const stepEl = document.getElementById('sql-query-step');
        
        // Detectar el tipo de consulta para mostrar el formulario adecuado
        if (/FROM\s+users/i.test(query) && /username\s*=\s*'[^']*'/.test(query)) {
            // Formulario de login (Retos 1-2)
            let userMatch = query.match(/username\s*=\s*'([^']*)'/i);
            let passMatch = query.match(/password\s*=\s*'([^']*)'/i);
            let user = userMatch ? userMatch[1] : '';
            let pass = passMatch ? passMatch[1] : '';
            let inyeccion = /(' OR '1'='1|UNION\s+SELECT|SLEEP\()/i.test(user);
            let inyeccionPass = /(' OR '1'='1|UNION\s+SELECT|SLEEP\()/i.test(pass);
            let userHtml = inyeccion ? `<span class='sql-red'>${user}</span>` : `<span class='sql-green'>${user}</span>`;
            let passHtml = inyeccionPass ? `<span class='sql-red'>${pass}</span>` : `<span class='sql-green'>${pass}</span>`;
            let html = `<form>\n  <input type="text" name="username" value="${userHtml}" />\n  <input type="password" name="password" value="${passHtml}" />\n  <button>Login</button>\n</form>`;
            stepEl.textContent = html;
        } else if (/FROM\s+products/i.test(query) && (/name LIKE '%[^%]*%'/i.test(query) || /ORDER BY/i.test(query))) {
            // Formulario de b√∫squeda de productos (Retos 2-5)
            let searchMatch = query.match(/name LIKE '%([^%]*)%'/i);
            let orderMatch = query.match(/ORDER BY\s+([^LIMIT;]+)/i);
            let limitMatch = query.match(/LIMIT\s+([^;]+)/i);
            
            let search = searchMatch ? searchMatch[1] : '';
            let orderBy = orderMatch ? orderMatch[1].trim() : '';
            let limit = limitMatch ? limitMatch[1].trim() : '';
            
            // Detectar inyecciones
            let searchInjection = /(UNION\s+SELECT|SLEEP\(|information_schema)/i.test(search);
            let orderInjection = /(SLEEP\(|information_schema|UNION|SELECT)/i.test(orderBy);
            let limitInjection = /(SLEEP\(|UNION|SELECT)/i.test(limit);
            
            let searchHtml = searchInjection ? `<span class='sql-red'>${search}</span>` : `<span class='sql-green'>${search}</span>`;
            let orderHtml = orderInjection ? `<span class='sql-red'>${orderBy}</span>` : `<span class='sql-green'>${orderBy}</span>`;
            let limitHtml = limitInjection ? `<span class='sql-red'>${limit}</span>` : `<span class='sql-green'>${limit}</span>`;
            
            let html = `<form>\n  <input type="text" name="search" value="${searchHtml}" placeholder="Buscar producto..." />`;
            if (orderBy) html += `\n  <input type="hidden" name="sort" value="${orderHtml}" />`;
            if (limit) html += `\n  <input type="hidden" name="limit" value="${limitHtml}" />`;
            html += `\n  <button>Buscar</button>\n</form>`;
            stepEl.textContent = html;
        } else if (/FROM\s+coupons/i.test(query) && /code\s*=\s*'[^']*'/.test(query)) {
            // Formulario de cup√≥n (Reto 3)
            let couponMatch = query.match(/code\s*=\s*'([^']*)'/i);
            let coupon = couponMatch ? couponMatch[1] : '';
            let inyeccion = /(SLEEP\()/i.test(coupon);
            let couponHtml = inyeccion ? `<span class='sql-red'>${coupon}</span>` : `<span class='sql-green'>${coupon}</span>`;
            let html = `<form>\n  <input type="text" name="coupon" value="${couponHtml}" />\n  <button>Validar</button>\n</form>`;
            stepEl.textContent = html;
        } else if (/FROM\s+information_schema/i.test(query)) {
            // Consulta de metadatos (Reto 4-6)
            let tableMatch = query.match(/FROM\s+(information_schema\.\w+)/i);
            let whereMatch = query.match(/WHERE\s+(.+?)(?:ORDER BY|LIMIT|;|$)/i);
            
            let table = tableMatch ? tableMatch[1] : '';
            let whereClause = whereMatch ? whereMatch[1].trim() : '';
            
            let tableHtml = `<span class='sql-red'>${table}</span>`;
            let whereHtml = whereClause ? `<span class='sql-red'>${whereClause}</span>` : '';
            
            let html = `<div class="meta-query">\n  <p>üîç Consulta de metadatos detectada:</p>\n  <p>Tabla: ${tableHtml}</p>`;
            if (whereHtml) html += `\n  <p>Filtro: ${whereHtml}</p>`;
            html += `\n</div>`;
            stepEl.innerHTML = html;
        } else if (/SELECT.*FROM.*WHERE/i.test(query) && (/UNION|SELECT.*\(SELECT/i.test(query))) {
            // Consultas complejas con UNION o subconsultas (Reto 6)
            let parts = query.split(/UNION/i);
            let html = `<div class="complex-query">\n  <p>üîó Consulta compuesta detectada:</p>`;
            
            parts.forEach((part, index) => {
                let isInjection = /information_schema|SELECT.*\(SELECT/i.test(part);
                let partClass = isInjection ? 'sql-red' : 'sql-blue';
                html += `\n  <p>Parte ${index + 1}: <span class='${partClass}'>${part.trim()}</span></p>`;
            });
            
            html += `\n</div>`;
            stepEl.innerHTML = html;
        } else {
            stepEl.textContent = '// Esperando una interacci√≥n...';
        }
    }

    function toggleHint(id) {
        const hintEl = document.getElementById(`hint-${id}`);
        if (hintEl) {
            hintEl.classList.toggle('hidden');
        }
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        
        if (toastMessage) {
            toastMessage.textContent = message;
        } else {
            toast.textContent = message;
        }
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    function updateQueryBreakdown(query, detectedInjection) {
        const breakdownEl = document.getElementById('breakdown-content');
        let breakdown = '<div class="space-y-2 text-xs">';
        
        // An√°lisis m√°s espec√≠fico para diferentes tipos de consultas
        let parts = {};
        
        // Identificar tipo de consulta y extraer partes
        if (/SELECT.*FROM.*WHERE/i.test(query)) {
            // Consulta SELECT t√≠pica
            parts.select = query.match(/SELECT\s+([^FROM]+)/i)?.[1]?.trim() || '';
            parts.from = query.match(/FROM\s+(\w+)/i)?.[1] || '';
            parts.where = query.match(/WHERE\s+(.+?)(?:ORDER BY|LIMIT|;|$)/i)?.[1]?.trim() || '';
            parts.orderBy = query.match(/ORDER BY\s+([^LIMIT;]+)/i)?.[1]?.trim() || '';
            parts.limit = query.match(/LIMIT\s+([^;]+)/i)?.[1]?.trim() || '';
        } else if (/SELECT.*FROM/i.test(query)) {
            // Consulta SELECT sin WHERE
            parts.select = query.match(/SELECT\s+([^FROM]+)/i)?.[1]?.trim() || '';
            parts.from = query.match(/FROM\s+(\w+)/i)?.[1] || '';
            parts.orderBy = query.match(/ORDER BY\s+([^LIMIT;]+)/i)?.[1]?.trim() || '';
            parts.limit = query.match(/LIMIT\s+([^;]+)/i)?.[1]?.trim() || '';
        }
        
        // Mostrar partes de la consulta
        if (parts.select) {
            // Resaltar SELECT maliciosos
            let selectHtml = parts.select;
            if (/UNION\s+SELECT/i.test(query)) {
                selectHtml = selectHtml.replace(/(UNION\s+SELECT[^,]*)/gi, '<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">$1</span>');
            }
            breakdown += `<div><span class="text-blue-400 font-bold">SELECT:</span> <span class="text-gray-300">${selectHtml}</span></div>`;
        }
        
        if (parts.from) {
            // Resaltar tablas sensibles
            let fromHtml = parts.from;
            if (/information_schema/i.test(parts.from)) {
                fromHtml = `<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">${parts.from}</span>`;
            }
            breakdown += `<div><span class="text-green-400 font-bold">FROM:</span> <span class="text-cyan-300">${fromHtml}</span></div>`;
        }
        
        if (parts.where) {
            // Resaltar payloads maliciosos en WHERE
            let whereHtml = parts.where;
            whereHtml = whereHtml.replace(/(OR\s+'1'='1'|OR\s+1=1|SLEEP\([^)]*\)|information_schema)/gi, '<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">$1</span>');
            breakdown += `<div><span class="text-yellow-400 font-bold">WHERE:</span> <span class="text-gray-300">${whereHtml}</span></div>`;
        }
        
        if (parts.orderBy) {
            // Resaltar ORDER BY maliciosos
            let orderByHtml = parts.orderBy;
            if (/SLEEP\(|information_schema|UNION|SELECT/i.test(parts.orderBy)) {
                orderByHtml = orderByHtml.replace(/(SLEEP\([^)]*\)|information_schema|UNION[^,]*|SELECT[^,]*)/gi, '<span class="text-red-400 font-bold bg-red-900/30 px-1 rounded">$1</span>');
            }
            breakdown += `<div><span class="text-purple-400 font-bold">ORDER BY:</span> <span class="text-gray-300">${orderByHtml}</span></div>`;
        }
        
        if (parts.limit) {
            breakdown += `<div><span class="text-indigo-400 font-bold">LIMIT:</span> <span class="text-gray-300">${parts.limit}</span></div>`;
        }
        
        // An√°lisis de inyecci√≥n espec√≠fico
        if (detectedInjection) {
            breakdown += '<div class="mt-3 p-3 bg-red-900/30 rounded border border-red-500">';
            breakdown += '<div class="text-red-400 font-bold text-sm mb-2">‚ö†Ô∏è INYECCI√ìN DETECTADA</div>';
            
            switch(detectedInjection.type) {
                case 'Inyecci√≥n Booleana Cl√°sica':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>T√©cnica:</strong> Manipulaci√≥n de condiciones l√≥gicas</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ La condici√≥n <code>OR \'1\'=\'1\'</code> siempre es verdadera</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Esto bypassa la autenticaci√≥n completamente</div>';
                    break;
                case 'Inyecci√≥n de Comentario':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>T√©cnica:</strong> Comentario de c√≥digo SQL</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Los comentarios <code>--</code> ignoran el resto de la consulta</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Permite saltarse validaciones como contrase√±as</div>';
                    break;
                case 'Ataque UNION SELECT':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>T√©cnica:</strong> Combinaci√≥n de consultas</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ <code>UNION SELECT</code> combina resultados de m√∫ltiples consultas</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Permite extraer datos de otras tablas</div>';
                    break;
                case 'Inyecci√≥n Basada en Tiempo':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>T√©cnica:</strong> An√°lisis temporal</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ <code>SLEEP()</code> introduce retrasos medibles</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Confirma vulnerabilidad sin mostrar datos</div>';
                    break;
                case 'Inyecci√≥n Basada en Errores':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>T√©cnica:</strong> Extracci√≥n por errores</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ <code>information_schema</code> contiene metadatos del sistema</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Los errores SQL pueden revelar estructura de BD</div>';
                    break;
                case 'Inyecci√≥n en ORDER BY/LIMIT':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>T√©cnica:</strong> Manipulaci√≥n de ordenamiento</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Inyecci√≥n en cl√°usulas de ordenamiento</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Puede provocar errores informativos</div>';
                    break;
                case 'Inyecci√≥n en Subconsulta':
                    breakdown += '<div class="text-red-300 text-xs mb-2"><strong>T√©cnica:</strong> Consultas anidadas</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Subconsultas pueden filtrar informaci√≥n</div>';
                    breakdown += '<div class="text-red-300 text-xs">‚Ä¢ Bypass de validaciones superficiales</div>';
                    break;
            }
            breakdown += '</div>';
        } else if (query.includes("'") || query.includes('"')) {
            breakdown += '<div class="mt-3 p-3 bg-yellow-900/30 rounded border border-yellow-500">';
            breakdown += '<div class="text-yellow-400 font-bold text-sm mb-1">‚ö†Ô∏è PRECAUCI√ìN</div>';
            breakdown += '<div class="text-yellow-300 text-xs">Se detectan comillas en la entrada. Usar par√°metros preparados previene inyecciones.</div>';
            breakdown += '</div>';
        }
        
        breakdown += '</div>';
        breakdownEl.innerHTML = breakdown;
    }

    function toggleDebugMenu() {
        const debugMenu = document.getElementById('db-monitoring-menu');
        const toggleBtn = document.getElementById('toggle-debug-btn');
        
        if (debugMenu.classList.contains('hidden')) {
            debugMenu.classList.remove('hidden');
            toggleBtn.textContent = 'üîß Ocultar Panel de Debug';
        } else {
            debugMenu.classList.add('hidden');
            toggleBtn.textContent = 'üîß Mostrar Panel de Debug';
        }
    }

    function unlockAllChallenges() {
        if (confirm('¬øEst√°s seguro de que quieres desbloquear todos los desaf√≠os? Esto puede afectar tu experiencia de aprendizaje.')) {
            state.unlockedLevels = [1, 2, 3, 4, 5, 6];
            updateUI();
            showToast('¬°Todos los desaf√≠os han sido desbloqueados!');
        }
    }

    function showSolutionsMenu() {
        if (confirm('‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n¬øEst√°s seguro de que quieres ver las soluciones? Esto arruinar√° la experiencia de aprendizaje y el desaf√≠o.\n\nEs mejor intentar resolver los problemas por ti mismo primero.\n\n¬øContinuar de todas formas?')) {
            document.getElementById('solutions-panel').classList.remove('hidden');
            document.getElementById('show-solutions-btn').disabled = true;
            document.getElementById('show-solutions-btn').textContent = 'üìã Soluciones Mostradas';
        }
    }

    function hideSolutionsMenu() {
        document.getElementById('solutions-panel').classList.add('hidden');
        document.getElementById('show-solutions-btn').disabled = false;
        document.getElementById('show-solutions-btn').textContent = 'üìã Ver Soluciones (¬°Spoiler!)';
    }

    // --- L√ìGICA DEL MEN√ö DE MONITOREO DE BASE DE DATOS ---
    function setupDbMonitoringMenu() {
        const selectEl = document.getElementById('challenge-select');
        const dbInfoContainer = document.getElementById('db-info-container');
        const resetButton = document.getElementById('reset-db-button');

        selectEl.addEventListener('change', async (event) => {
            const challengeId = event.target.value;
            if (!challengeId || !SQL) {
                dbInfoContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">Selecciona una base de datos para ver su estructura y datos.</p>';
                resetButton.disabled = true;
                return;
            }

            resetButton.disabled = false;
            const db = state.dbInstances[challengeId];
            if (!db) {
                dbInfoContainer.innerHTML = '<p class="text-red-500 text-center">Error: No se encontr√≥ la instancia de base de datos para este desaf√≠o.</p>';
                return;
            }

            displayDbInfo(db, dbInfoContainer, challengeId);
        });

        resetButton.addEventListener('click', async () => {
            const challengeId = selectEl.value;
            if (!challengeId || !SQL) return;

            console.log(`Reseteando base de datos para el desaf√≠o ${challengeId}...`);
            try {
                // Re-crear la instancia de la base de datos espec√≠fica
                // Esto requiere que las funciones de creaci√≥n sean modulares o una funci√≥n general.
                // Por ahora, vamos a re-ejecutar la parte relevante de setupAllChallengeDatabases.
                // Esto es una simplificaci√≥n; idealmente, tendr√≠as funciones separadas por DB.

                // Guardar la base de datos antigua por si falla la recreaci√≥n
                const oldDb = state.dbInstances[challengeId];

                if (challengeId === "1") {
                    state.dbInstances[1] = new SQL.Database();
                    state.dbInstances[1].run("CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, password TEXT);");
                    state.dbInstances[1].run("INSERT INTO users (username, password) VALUES ('admin', 'ultra-secret-password-123');");
                    state.dbInstances[1].run("INSERT INTO users (username, password) VALUES ('juan', 'password123');");
                    state.dbInstances[1].run("INSERT INTO users (username, password) VALUES ('ana', 'qwerty');");
                } else if (challengeId === "2") { // Cubre 2, 4, 5
                    state.dbInstances[2] = new SQL.Database();
                    state.dbInstances[2].run("CREATE TABLE products (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, description TEXT, price REAL);");
                    state.dbInstances[2].run("INSERT INTO products (name, description, price) VALUES ('Laptop Pro', 'Potente laptop para profesionales.', 1200.50);");
                    state.dbInstances[2].run("INSERT INTO products (name, description, price) VALUES ('Teclado Mec√°nico RGB', 'Teclado con switches cherry-mx.', 75.00);");
                    state.dbInstances[2].run("INSERT INTO products (name, description, price) VALUES ('Monitor Ultrawide', 'Monitor de 34 pulgadas curvo.', 450.99);");
                    state.dbInstances[2].run("CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, password TEXT, email TEXT);");
                    state.dbInstances[2].run("INSERT INTO users (username, password, email) VALUES ('admin', 'adminPass123!', 'admin@example.com');");
                    state.dbInstances[2].run("INSERT INTO users (username, password, email) VALUES ('user1', 'securePass!', 'user1@example.com');");
                    state.dbInstances[2].run("INSERT INTO users (username, password, email) VALUES ('user2', 'password123', 'user2@example.com');");
                    state.dbInstances[4] = state.dbInstances[2];
                    state.dbInstances[5] = state.dbInstances[2];
                } else if (challengeId === "3") {
                    state.dbInstances[3] = new SQL.Database();
                    state.dbInstances[3].run("CREATE TABLE coupons (id INTEGER PRIMARY KEY AUTOINCREMENT, code TEXT, discount REAL, expiry_date TEXT);");
                    state.dbInstances[3].run("INSERT INTO coupons (code, discount, expiry_date) VALUES ('SUMMER20', 0.20, '2024-08-31');");
                    state.dbInstances[3].run("INSERT INTO coupons (code, discount, expiry_date) VALUES ('SAVE10NOW', 0.10, '2024-12-31');");
                } else if (challengeId === "6") {
                    state.dbInstances[6] = new SQL.Database();
                    state.dbInstances[6].run("CREATE TABLE items (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT, owner_id INTEGER);");
                    state.dbInstances[6].run("INSERT INTO items (name, owner_id) VALUES ('Documento Secreto', 1);");
                    state.dbInstances[6].run("INSERT INTO items (name, owner_id) VALUES ('Llave Maestra', 1);");
                    state.dbInstances[6].run("INSERT INTO items (name, owner_id) VALUES ('Notas P√∫blicas', 2);");
                    state.dbInstances[6].run("CREATE TABLE users (id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT, role TEXT);");
                    state.dbInstances[6].run("INSERT INTO users (username, role) VALUES ('admin', 'administrator');");
                    state.dbInstances[6].run("INSERT INTO users (username, role) VALUES ('guest', 'visitor');");
                }

                console.log(`Base de datos para el desaf√≠o ${challengeId} reseteada.`);
                showToast(`Base de datos del desaf√≠o ${challengeId} reseteada.`);
                // Refrescar la vista
                displayDbInfo(state.dbInstances[challengeId], dbInfoContainer, challengeId);

            } catch (err) {
                console.error(`Error reseteando la base de datos del desaf√≠o ${challengeId}:`, err);
                dbInfoContainer.innerHTML = `<p class="text-red-500 text-center">Error al resetear la base de datos: ${err.message}</p>`;
                // Restaurar la base de datos antigua si es posible (o re-inicializar todo)
                // state.dbInstances[challengeId] = oldDb; // Podr√≠a no ser seguro si oldDb fue cerrado o corrupto
            }
        });
    }

    function displayDbInfo(db, container, challengeId) {
        container.innerHTML = ''; // Limpiar contenido anterior

        try {
            // Obtener lista de tablas
            const tablesResult = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%';");

            if (!tablesResult || tablesResult.length === 0 || tablesResult[0].values.length === 0) {
                container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No hay tablas en esta base de datos.</p>';
                return;
            }

            const tableNames = tablesResult[0].values.flat();
            let htmlContent = `<h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3">Esquema y Datos (Desaf√≠o ${challengeId})</h3>`;

            tableNames.forEach(tableName => {
                htmlContent += `<div class="mb-4 p-3 bg-gray-200 dark:bg-gray-800 rounded">`;
                htmlContent += `<h4 class="text-md font-semibold text-blue-600 dark:text-blue-400 mb-1">${tableName}</h4>`;

                // Obtener esquema de la tabla
                const schemaResult = db.exec(`PRAGMA table_info(${tableName});`);
                if (schemaResult && schemaResult.length > 0) {
                    htmlContent += `<p class="text-xs text-gray-600 dark:text-gray-400 mb-1">Columnas: ${schemaResult[0].values.map(col => `${col[1]} (${col[2]})`).join(', ')}</p>`;
                }

                // Obtener datos de la tabla (limitar a, por ejemplo, 10 filas para evitar sobrecargar)
                const dataResult = db.exec(`SELECT * FROM ${tableName} LIMIT 10;`);
                if (dataResult && dataResult.length > 0 && dataResult[0].values.length > 0) {
                    htmlContent += `<table class="min-w-full text-xs divide-y divide-gray-300 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>${dataResult[0].columns.map(col => `<th class="px-2 py-1 text-left font-medium text-gray-500 dark:text-gray-300">${col}</th>`).join('')}</tr>
                                        </thead>
                                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">`;
                    dataResult[0].values.forEach(row => {
                        htmlContent += `<tr>${row.map(cell => `<td class="px-2 py-1 whitespace-nowrap text-gray-700 dark:text-gray-200 font-fira">${cell === null ? 'NULL' : cell}</td>`).join('')}</tr>`;
                    });
                    htmlContent += `</tbody></table>`;
                    if (dataResult[0].values.length === 10) {
                         htmlContent += `<p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Mostrando las primeras 10 filas.</p>`;
                    }
                } else {
                    htmlContent += `<p class="text-xs text-gray-500 dark:text-gray-400">La tabla est√° vac√≠a.</p>`;
                }
                htmlContent += `</div>`;
            });
            container.innerHTML = htmlContent;

        } catch (e) {
            console.error("Error mostrando informaci√≥n de la BD:", e);
            container.innerHTML = `<p class="text-red-500 text-center">Error al obtener informaci√≥n de la base de datos: ${e.message}</p>`;
        }
    }

    </script>
</body>
</html>